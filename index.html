
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 關東自駕遊 App</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-black': '#121212',
                        'jp-dark': '#1e1e1e',
                        'jp-gray': '#2c2c2c',
                        'jp-light': '#e5e5e5',
                        'jp-red': '#b91c1c', 
                        'jp-gold': '#c5a059',
                        'jp-indigo': '#312e81',
                        'jp-accent': '#d4af37',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s ease-out',
                        'fade-in': 'fadeIn 0.3s ease-out',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #121212; color: #e5e5e5; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glass-panel { background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .card-bg-gradient { background: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 100%); }
        .pt-env-top { padding-top: env(safe-area-inset-top, 20px); }
        .pb-env-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-left-color: #c5a059; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Line Clamp for Card Descriptions */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "firebase/": "https://aistudiocdn.com/firebase@^12.6.0/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        // 您的設定
        const firebaseConfig = {
            apiKey: "AIzaSyBjTfFaJfN6Vbv3_PjykOS5IjEwewtKNk4",
            authDomain: "japantripapp-ff22f.firebaseapp.com",
            projectId: "japantripapp-ff22f",
            storageBucket: "japantripapp-ff22f.firebasestorage.app",
            messagingSenderId: "865746692066",
            appId: "1:865746692066:web:f853fde276f0940785fbbb"
        };

        try {
            const app = initializeApp(firebaseConfig);
            
            // 將功能掛載到 window 供 React 使用
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            window.storage = getStorage(app);
            
            window.firebaseModules = { 
                signInAnonymously, collection, doc, setDoc, deleteDoc, onSnapshot,
                ref, uploadBytes, getDownloadURL, deleteObject 
            };
            console.log("Firebase & Storage initialized successfully");
        } catch (e) {
            console.error("Firebase init error:", e);
        }
    </script>

    <!-- React Application Logic -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Data ---
        // 定義一個共用的 Trip ID，讓所有裝置讀取同一個位置
        const SHARED_TRIP_ID = 'shared_kanto_2026';

        const INITIAL_ITINERARY = [
            {
                id: 'day1', dayLabel: 'Day 1', date: '2/8 (日)', title: '啟程東京', location: '台北 -> 成田', 
                coords: { lat: 35.7719, lon: 140.3929 }, // Narita
                events: [
                    { id: 'd1-1', type: 'transport', time: '12:50', title: '捷星航空 GK14', desc: '台北(TPE) T1 -> 東京(NRT) T3。', nav: 'Narita International Airport Terminal 3', highlight: '行李：手提7kg / 託運30kg+20kg', travelInfo: '機場接駁 | 30分' },
                    { 
                        id: 'd1-2', type: 'stay', time: '18:00', title: '東橫INN 成田機場 本館', 
                        desc: '作為抵達日本後的第一站，這裡擁有極佳的後勤優勢。飯店規模巨大，提供極為密集的免費接駁巴士往返成田機場（約15分鐘），對於租車前後的緩衝非常方便。雖然房間是標準的商務配置，但乾淨整潔。大廳設有自動報到機與寬敞的休息區，並有Lawson便利商店，方便深夜抵達補充物資。這裡的自助早餐品項在東橫INN體系中算豐富，能讓您在出發取車前吃飽喝足。', 
                        nav: 'Toyoko Inn Narita Airport Honkan', highlight: '已預訂 (早餐/停車付費)', subInfo: '¥11,495 (現場付)' 
                    }
                ]
            },
            {
                id: 'day2', dayLabel: 'Day 2', date: '2/9 (一)', title: '茨城名瀑與鮟鱇魚', location: '成田 -> 水戶',
                coords: { lat: 36.3659, lon: 140.4712 }, // Mito
                events: [
                    { id: 'd2-0', type: 'stay', time: '08:30', title: '出發：東橫INN 成田機場', desc: '辦理退房，前往租車。', nav: 'Toyoko Inn Narita Airport Honkan', highlight: '記得帶走所有行李', travelInfo: '接駁車 | 15分' },
                    { id: 'd2-1', type: 'transport', time: '09:00', title: '租車取車', desc: 'Toyota Rent a Car 成田機場店。Sienta HEV。', nav: 'Toyota Rent a Car Narita Airport', highlight: '預約番號：99758887600', subInfo: '費用：¥108,900', travelInfo: '85km | 2小時' },
                    { 
                        id: 'd2-2', type: 'sight', time: '10:30', title: '袋田瀑布', 
                        desc: '日本三大名瀑之一，高120公尺、寬73公尺，水流沿著四段岩壁傾瀉而下，因此又被稱為「四度之瀧」。冬季是這裡最獨特的季節，嚴寒時瀑布會結凍成雪白的冰壁，形成極為壯觀的「冰瀑」奇景，若運氣好遇到完全結凍，景色更是令人屏息。遊客需通過隧道前往觀瀑台，第一觀瀑台可近距離感受水氣（或冰氣），搭乘電梯至第二觀瀑台則能俯瞰全景。周邊有著名的奥久慈軍雞料理與蘋果派，是自駕旅客補充體力的好去處。', 
                        nav: 'Fukuroda Falls', highlight: '建議停留1小時', travelInfo: '45km | 1小時' 
                    },
                    { 
                        id: 'd2-3', type: 'food', time: '12:45', title: '午餐：鮟鱇魚鍋', 
                        desc: '茨城縣冬季最具代表性的極品美食。道地的鮟鱇魚鍋通常以味噌為基底，將魚肝融入湯頭中，煮出濃郁橘黃色的精華高湯。', 
                        nav: 'Sansui Mito', highlight: '必吃：鮟鱇魚肝味噌湯底', travelInfo: '市區 | 15分' 
                    },
                    { 
                        id: 'd2-4', type: 'sight', time: '14:30', title: '偕樂園 賞梅', 
                        desc: '與金澤兼六園、岡山後樂園並列為「日本三大名園」。偕樂園以梅花聞名，園內種植了約100種、3000株梅花。若您於2月至3月造訪，正值「水戶梅花祭」，早開的梅花在雪景或寒空中綻放，香氣襲人。園內的「好文亭」是德川齊昭公親自設計的木造建築，登樓可遠眺千波湖的優美風光。這裡地形平緩，不僅適合散步，其陰陽對比的造園美學（孟宗竹林的「陰」與梅林的「陽」）更充滿了江戶時代的文人雅趣。', 
                        nav: 'Kairakuen', highlight: '可參觀好文亭', travelInfo: '市區 | 10分' 
                    },
                    { 
                        id: 'd2-5', type: 'stay', time: '17:00', title: 'Dormy Inn 水戶', 
                        desc: 'Dormy Inn 系列的最大賣點在於「天然溫泉」與「夜鳴拉麵」。位於水戶市中心的這間分館，頂樓設有露天溫泉「香梅之湯」，能一邊泡湯一邊眺望水戶市區夜景，消除駕駛疲勞。泡完湯後，飯店提供免費的宵夜醬油拉麵（夜鳴きそば），簡單卻暖胃。早餐通常會提供茨城名產「納豆」與當地鄉土料理（如鮟鱇魚料理等，視季節而定），走路即可抵達餐廳林立的繁華街，地理位置優越。', 
                        nav: 'Dormy Inn Mito', highlight: '設施：大浴場/桑拿', travelInfo: '步行/短程' 
                    },
                    { 
                        id: 'd2-6', type: 'food', time: '18:30', title: '晚餐：常陸牛', 
                        desc: '茨城縣引以為傲的頂級黑毛和牛品牌。其特徵是如大理石般細緻分佈的霜降油花，肉質軟嫩，入口即化。', 
                        nav: 'Restaurant Iijima', highlight: '必吃：牛排/壽喜燒' 
                    }
                ]
            },
            {
                id: 'day3', dayLabel: 'Day 3', date: '2/10 (二)', title: '日光東照宮', location: '水戶 -> 日光',
                coords: { lat: 36.7199, lon: 139.6982 }, // Nikko
                events: [
                    { id: 'd3-0', type: 'stay', time: '08:30', title: '出發：Dormy Inn 水戶', desc: '辦理退房。', nav: 'Dormy Inn Mito', highlight: '早餐後出發', travelInfo: '50km | 50分' },
                    { 
                        id: 'd3-1', type: 'sight', time: '09:20', title: '常陸國出雲大社', 
                        desc: '位於笠間市，雖然是島根縣出雲大社的分社，但其規模與氣勢毫不遜色。最著名的地標是拜殿上掛著的巨大注連繩，重達6噸，魄力十足，許多遊客會在此嘗試將硬幣投向注連繩底部以求好運。這裡主祭大國主大神，是著名的「結緣」聖地，不僅祈求姻緣，也包含工作與人際關係的緣分。神社境內還設有玻璃工坊與現代藝術展館，氛圍比一般神社更具開放感與現代感，從高處眺望的茨城鄉野景色也十分遼闊。', 
                        nav: 'Hitachinokuni Izumo Taisha', highlight: '參拜時間約40-60分', travelInfo: '90km | 1.5小時' 
                    },
                    { id: 'd3-2', type: 'food', time: '12:20', title: '午餐：日光湯波料理', desc: '日光名物豆皮料理。推薦：和風餐廳 Yubazen。', nav: 'Yubazen Nikko', highlight: '豆皮料理', travelInfo: '短程 | 10分' },
                    { 
                        id: 'd3-3', type: 'sight', time: '13:30', title: '日光東照宮', 
                        desc: '世界文化遺產，也是供奉江戶幕府初代將軍德川家康的神社。建築群金碧輝煌，運用了超過5000尊雕刻，展現了江戶初期工藝的巔峰。最知名的包括祈求和平的「眠貓」以及寓意非禮勿視、非禮勿言、非禮勿聽的「三猿」。核心建築「陽明門」被譽為「日暮之門」，意指其精美程度讓人看上一整天也不會厭倦。冬季的東照宮雖然寒冷，但白雪覆蓋在金色的屋簷與色彩鮮豔的雕刻上，形成莊嚴肅穆的對比美感，是攝影愛好者的絕佳素材。', 
                        nav: 'Nikko Toshogu', highlight: '必看：三猿、眠貓、陽明門', travelInfo: '15km | 40分 (山路)' 
                    },
                    { 
                        id: 'd3-4', type: 'sight', time: '15:40', title: '華嚴瀑布 & 中禪寺湖', 
                        desc: '華嚴瀑布是男體山噴發後截斷河流形成的壯麗景觀，落差高達97公尺，名列日本三大名瀑。搭乘專用電梯下降至觀瀑台，能感受到水聲如雷的震撼力。冬季時，瀑布周圍的細小水流會結成數不清的藍色冰柱（十二瀑），極具神祕感。緊鄰的中禪寺湖是日本海拔最高的天然湖泊（約1269公尺），湖水清澈湛藍。冬季湖畔風勢強勁且寒冷，但空氣極度通透，能清楚看見男體山的倒影。此處道路（伊路波坂）多彎，自駕需特別注意路面凍結。', 
                        nav: 'Kegon Falls', highlight: '電梯16:30關閉', travelInfo: '50km | 1小時' 
                    },
                    { 
                        id: 'd3-5', type: 'stay', time: '17:30', title: '東橫INN 宇都宮站前', 
                        desc: '位於「餃子之都」宇都宮的核心地帶，距離JR宇都宮站步行僅需極短時間。飯店維持東橫INN一貫的穩定品質與明亮清潔感。選擇這裡的最大優勢是周邊美食機能強大，車站周邊匯集了像是「Minmin」、「正嗣」等多家知名的宇都宮餃子名店，晚餐可以輕鬆安排一場餃子巡禮。對於自駕者來說，這裡提供機械式停車塔（需注意車高限制）或特約停車場，作為前往日光或北上的中繼站非常合適。', 
                        nav: 'Toyoko Inn Utsunomiya-eki Mae 1', highlight: '', travelInfo: '步行' 
                    },
                    { 
                        id: 'd3-6', type: 'food', time: '18:30', title: '晚餐：宇都宮餃子', 
                        desc: '宇都宮市被稱為「餃子之都」，市內擁有超過 200 家餃子專賣店。', 
                        nav: 'Kirasse Honten', highlight: '餃子之都巡禮' 
                    }
                ]
            },
            {
                id: 'day4', dayLabel: 'Day 4', date: '2/11 (三)', title: '足利古城與雪國', location: '宇都宮 -> 南魚沼',
                coords: { lat: 37.0645, lon: 138.8785 },
                events: [
                    { id: 'd4-0', type: 'stay', time: '09:00', title: '出發：東橫INN 宇都宮', desc: '睡飽出發，經北關東道前往足利。', nav: 'Toyoko Inn Utsunomiya-eki Mae 1', highlight: '', travelInfo: '55km | 50分' },
                    { 
                        id: 'd4-1', type: 'sight', time: '10:00', title: '足利氏館 (鑁阿寺)', 
                        desc: '位於足利市中心，是室町幕府將軍足利氏的發源地。鑁阿寺（Bannaji）原是足利氏的居館，後來改建為寺院，因此保留了護城河與土壘等防禦工事，呈現獨特的「寺城並存」樣貌。本堂已被指定為日本國寶，建築風格古樸厚重，充滿武家文化的剛健氣息。境內有一棵樹齡超過650年的大銀杏，氣勢非凡。參拜後，推薦在參道上品嚐當地著名的「足利燒賣（不含肉的洋蔥燒賣）」或「馬鈴薯炒麵」，感受在地B級美食的魅力。', 
                        nav: 'Bannaji Temple', highlight: '國寶本堂/日本百名城', travelInfo: '50km | 50分' 
                    },
                    { 
                        id: 'd4-2', type: 'food', time: '12:30', title: '午餐：高崎名物', 
                        desc: '推薦嘗試群馬名物：\n1. 「登利平」鳥飯 (Torihei)：群馬縣民的靈魂便當，醬汁雞肉飯。\n2. 「高崎義大利麵」：以份量大、口味濃郁著稱。', 
                        nav: 'Torihei Honten', travelInfo: '10km | 20分' 
                    },
                    { 
                        id: 'd4-3', type: 'sight', time: '13:45', title: '少林山達摩寺', 
                        desc: '這裡是日本吉祥物「高崎達摩（不倒翁）」的發源地。寺院依山而建，階梯兩旁與本堂周圍堆滿了無數遊客還願送回的達摩，景象壯觀且充滿福氣。高崎達摩以眉毛像鶴、鬍鬚像龜的特徵著稱，象徵長壽與吉利。您可以在這裡購買新的達摩，畫上左眼許願，待願望實現後再畫上右眼。寺內還設有一間小型博物館，展示日本各地不同造型的達摩。對於自駕旅行者來說，這裡是祈求「交通安全」與「旅途順利」的絕佳能量景點。', 
                        nav: 'Shorinzan Darumaji', highlight: '達摩發源地', travelInfo: '120km | 2小時 (關越道)' 
                    },
                    { 
                        id: 'd4-4', type: 'transport', time: '14:30', title: '前往南魚沼', 
                        desc: '經由關越自動車道，穿越長長的「關越隧道」後，世界會瞬間變成銀白色的豪雪地帶 (川端康成《雪國》舞台)。請注意雪地駕駛。', 
                        nav: 'Sakadojo', highlight: '穿越豪雪隧道', travelInfo: '抵達飯店' 
                    },
                    { 
                        id: 'd4-5', type: 'stay', time: '16:00', title: '坂戶城 溫泉旅館', 
                        desc: '這是一間充滿歷史情懷的溫泉旅館，建立在戰國武將長尾政景（上杉景勝之父）的居城「坂戶城」遺址山腳下。旅館洋溢著大河劇般的懷舊氛圍，大廳展示著相關的甲冑與歷史文物。這裡的溫泉屬於「開運之湯」，露天風呂視野開闊，冬季可欣賞新潟著名的豪雪景致。餐點主打南魚沼產的特A級越光米與當地山海產，是整趟行程中最具「日式旅情」與歷史深度的住宿體驗。', 
                        nav: 'Sakadojo', highlight: '提早入住享受溫泉', travelInfo: '接駁/短程' 
                    },
                    { 
                        id: 'd4-6', type: 'food', time: '18:00', title: '晚餐：南魚沼越光米', 
                        desc: '晚餐推薦名單：\n1. 「欅亭 (Keyaki Tei)」：極品洋食與米飯。\n2. 「魚沼釜蔵」：鄉土料理與地酒。', 
                        nav: 'Keyaki Tei', highlight: '推薦：Keyaki Tei 洋食' 
                    }
                ]
            },
            {
                id: 'day5', dayLabel: 'Day 5', date: '2/12 (四)', title: '工藝與能量', location: '南魚沼 -> 新潟',
                coords: { lat: 37.6366, lon: 138.9616 },
                events: [
                    { id: 'd5-0', type: 'stay', time: '08:15', title: '出發：坂戶城', desc: '辦理退房，提早出發以免塞車。', nav: 'Sakadojo', highlight: '雪地駕車小心', travelInfo: '60km | 50分' },
                    { 
                        id: 'd5-1', type: 'sight', time: '09:45', title: '三条鍛冶道場', 
                        desc: '燕三條地區是世界聞名的金屬工藝聖地，這座道場是專門體驗鍛造文化的設施。不同於一般只能參觀的工廠，這裡提供遊客親手製作拆信刀或和釘的體驗（需預約）。在專業職人的指導下，您可以親自將燒得火紅的鐵塊敲打成型，感受金屬變化的過程。館內亦展示了各種三條生產的優質刀具、工具與農具。對於喜歡工藝或想深入了解日本職人精神的旅客，這裡是極具教育意義與互動樂趣的停留點，成品更是獨一無二的紀念品。', 
                        nav: 'Sanjo Blacksmith Dojo', highlight: '上午場只到11:00', travelInfo: '20km | 30分' 
                    },
                    { 
                        id: 'd5-2', type: 'sight', time: '11:00', title: '彌彥神社', 
                        desc: '越後國的一宮，被當地人親切地稱為「彌彥樣」，是新潟縣內格調最高的神社。神社坐落在神山「彌彥山」山腳，四周被古老的杉樹林環繞，氣氛莊嚴清幽。這裡以祈求工作運、比賽運聞名，據說能量強大。拜殿莊嚴宏偉，在此參拜後，可以搭乘附近的彌彥山纜車登頂，俯瞰越後平原與日本海的絕景。冬季若積雪，朱紅色的鳥居在雪地中更顯醒目。彌彥溫泉街就在附近，參拜後可順道享受足湯或購買著名的「咖哩豆」當伴手禮。', 
                        nav: 'Yahiko Shrine', highlight: '午餐：釜飯彌醉亭 或 熊貓燒', travelInfo: '40km | 50分' 
                    },
                    { 
                        id: 'd5-3', type: 'sight', time: '15:30', title: 'Pier Bandai', 
                        desc: '被譽為「新潟的廚房」，是一個集合了水產市場、肉舖、農產與餐飲的大型複合設施。位於新潟市區萬代島，交通便利。這裡最大的亮點是極致新鮮的海鮮，尤其是迴轉壽司名店「弁慶」，經常大排長龍，能以實惠價格吃到佐渡產的肥美寒鰤魚與南蠻蝦。除了壽司，您也可以在市場買到新潟知名的越光米、清酒以及各式海鮮加工品。這裡也設有戶外燒烤區（季節限定），氣氛熱鬧，是午餐與採購新潟特產的最佳地點。', 
                        nav: 'Pier Bandai', highlight: '推薦：弁慶壽司、爆彈飯糰', travelInfo: '市區 | 10分' 
                    },
                    { 
                        id: 'd5-4', type: 'stay', time: '17:00', title: '東橫INN 新潟站前', 
                        desc: '位於新潟交通樞紐，對於探索新潟市區極為便利。雖然是連鎖商務飯店，但新潟的東橫INN早餐通常會提供高品質的新潟米，這是一大亮點。周邊步行可達居酒屋街與拉麵店，方便品嚐新潟著名的「醬汁豬排丼」或「生薑醬油拉麵」。飯店擁有完善的停車設施（立體停車場），且緊鄰通往隔天長野方向的快速道路入口，是機能性極高的戰略住宿點。', 
                        nav: 'Toyoko Inn Niigata Ekimae', highlight: '', travelInfo: '步行' 
                    },
                    { 
                        id: 'd5-5', type: 'food', time: '18:00', title: '晚餐：新潟站前', 
                        desc: '新潟車站前居酒屋激戰區。推薦嘗試新潟名物「醬汁豬排丼」(Tare-Katsu)。', 
                        nav: 'Niigata Station', highlight: '推薦：炸豬排太郎(醬汁豬排)、須坂屋(布海苔蕎麥麵)' 
                    }
                ]
            },
            {
                id: 'day6', dayLabel: 'Day 6', date: '2/13 (五)', title: '野猿公苑與壽司', location: '新潟 -> 長野',
                coords: { lat: 36.7329, lon: 138.4621 },
                events: [
                    { id: 'd6-0', type: 'stay', time: '09:00', title: '出發：東橫INN 新潟站前', desc: '辦理退房，出發前往妙高/長野方向。', nav: 'Toyoko Inn Niigata Ekimae', highlight: '確認車況與雪胎', travelInfo: '110km | 1小時45分' },
                    { 
                        id: 'd6-1', type: 'transport', time: '10:45', title: '道之驛 Arai (午餐)', 
                        desc: '位於上信越自動車道旁，是一個與高速公路休息站連通的「Highway Oasis」。這裡不僅是休息站，更像是一個美食聚落。', 
                        nav: 'Roadside Station Arai', highlight: '必吃：白蝦/鰤魚/螃蟹', travelInfo: '休息站內' 
                    },
                    { id: 'd6-2', type: 'food', time: '12:00', title: 'Kito Kito 壽司', desc: '享用美味壽司午餐。平板點餐，出餐快速。', nav: 'Kito Kito Sushi Arai', highlight: '平板點餐', travelInfo: '45km | 45分' },
                    { id: 'd6-3', type: 'transport', time: '12:45', title: '前往野猿公苑', desc: '信州中野IC下，往志賀高原。', nav: 'Jigokudani Monkey Park Parking', highlight: 'MapCode: 341 740 584*55', travelInfo: '步行 1.6km (30分)' },
                    { 
                        id: 'd6-4', type: 'sight', time: '13:40', title: '地獄谷野猿公苑', 
                        desc: '世界唯一可以看到野生猴子泡溫泉的地方。位於志賀高原的山林深處，冬季時整個山谷被白雪覆蓋，當地的日本獼猴為了禦寒，會跳入露天溫泉中一臉享受地泡湯，這幅景象被外國遊客稱為「Snow Monkey」，聞名全球。從停車場需步行約30分鐘的山路才能抵達，冬季步道濕滑，建議穿著防滑雪靴。看著猴子們互相理毛、在溫泉中打瞌睡的模樣非常療癒，是冬季長野最不可錯過的生態奇觀。', 
                        nav: 'Jigokudani Monkey Park', highlight: '裝備：手套/毛帽/防滑鞋', travelInfo: '步行回程+駕車 (35km | 50分)' 
                    },
                    { id: 'd6-5', type: 'transport', time: '15:30', title: '前往長野市區', desc: '天黑前下山，前往飯店。', nav: 'Toyoko Inn Nagano-eki Higashi-guchi', highlight: '小心傍晚路況', travelInfo: '市區 | 10分' },
                    { 
                        id: 'd6-6', type: 'stay', time: '16:20', title: '東橫INN 長野站東口', 
                        desc: '長野站東口相較於善光寺口較為清靜，道路寬敞，非常適合自駕者進出。這間飯店距離車站步行不到5分鐘，對於隔天要前往善光寺或地獄谷野猿公苑都相當順路。長野冬季寒冷，東橫INN穩定的暖氣與加濕器是必備設施。大廳寬敞，早餐通常會有信州味噌湯或當地漬物等簡單的鄉土風味。附近有租車公司據點與加油站，對於整備車輛相當方便。', 
                        nav: 'Toyoko Inn Nagano-eki Higashi-guchi', highlight: '機械停車塔', travelInfo: '步行' 
                    },
                    { 
                        id: 'd6-7', type: 'food', time: '18:00', title: '晚餐：長野站前', 
                        desc: '兩大推薦：1. 「醬汁豬排丼」(明治亭)。2. 「味噌家」(Misoya) 拉麵。', 
                        nav: 'Nagano Station', highlight: '推薦：明治亭(醬汁豬排)、味噌家(拉麵)' 
                    }
                ]
            },
            {
                id: 'day7', dayLabel: 'Day 7', date: '2/14 (六)', title: '安曇野與諏訪', location: '長野 -> 甲府',
                coords: { lat: 36.0485, lon: 138.1130 },
                events: [
                    { id: 'd7-0', type: 'stay', time: '09:00', title: '出發：東橫INN 長野', desc: '辦理退房。', nav: 'Toyoko Inn Nagano-eki Higashi-guchi', highlight: '', travelInfo: '60km | 50分' },
                    { 
                        id: 'd7-1', type: 'sight', time: '10:15', title: '穂高神社', 
                        desc: '位於安曇野市，被尊為「日本阿爾卑斯山的總鎮守」。主祭神是海神之子「穗高見命」，守護著這片壯麗的山脈與交通安全。神社境內古木參天，氣氛靜謐，其中一棵「孝養杉」樹齡超過500年，相當壯觀。這裡有獨特的「不銹鋼鳥居」與「道祖神」文化，反映了當地的信仰特色。由於緊鄰交通要道且守護交通安全，非常適合自駕旅客來此進行「車祓（為車子祈福）」或購買交通安全御守，祈求接下來的山路行程一路平安。', 
                        nav: 'Hotaka Shrine', highlight: '順遊大王山葵農場', travelInfo: '短程 | 10分' 
                    },
                    { 
                        id: 'd7-2', type: 'food', time: '11:30', title: '午餐：信州蕎麥麵', 
                        desc: '長野縣（信州）是蕎麥麵的發源地之一，因地形高、溫差大且水質純淨，種出的蕎麥品質極佳。', 
                        nav: 'Sobadokoro Kamijo', highlight: '推薦：そば処上條', travelInfo: '50km | 1小時' 
                    },
                    { 
                        id: 'd7-3', type: 'sight', time: '14:00', title: '立石公園 (諏訪湖)', 
                        desc: '位於諏訪湖東側的高地上，是俯瞰諏訪湖全景的最佳地點。這裡因為景色酷似動畫電影《你的名字》中「糸守湖」的黃昏場景而爆紅，成為聖地巡禮的熱門景點。不僅白天能將壯闊的湖面與遠處的日本阿爾卑斯山盡收眼底，黃昏時分的夕陽與入夜後的夜景更是迷人，被選為「日本夜景遺產」。公園設有大型溜滑梯與展望台，雖然冬季風大寒冷，但那種開闊的視野與感動絕對值得一遊。', 
                        nav: 'Tateishi Park', highlight: '立石公園俯瞰全景', travelInfo: '60km | 1小時' 
                    },
                    { 
                        id: 'd7-4', type: 'stay', time: '17:15', title: 'Dormy Inn 甲府', 
                        desc: '位於山梨縣甲府市中心，這間Dormy Inn最令人期待的是頂樓的天然溫泉「勝運之湯」。甲府是武田信玄的領地，飯店位置極佳，步行可至甲府城跡。这里的溫泉是名副其實的「甲府黑湯」，水質呈琥珀色，保溫效果極佳。早餐是重頭戲，通常提供山梨名物「餺飥（Hoto麵）」與「雞雜煮」，讓您不需排隊名店也能吃到在地美食。當然，晚上的免費拉麵也是不可或缺的享受。', 
                        nav: 'Dormy Inn Kofu Marunouchi', highlight: '', travelInfo: '步行' 
                    },
                    { 
                        id: 'd7-5', type: 'food', time: '18:30', title: '晚餐：甲府餺飥麵', 
                        desc: '山梨縣最具代表性的鄉土料理，相傳是戰國武將武田信玄的野戰食品。特徵是使用寬扁的麵條，加入大量的南瓜、蔬菜與豬肉。', 
                        nav: 'Kosaku Kofu Station', highlight: '推薦：小作 (南瓜餺飥)' 
                    }
                ]
            },
            {
                id: 'day8', dayLabel: 'Day 8', date: '2/15 (日)', title: '富士山與箱根', location: '甲府 -> 箱根',
                coords: { lat: 35.4925, lon: 138.7562 },
                events: [
                    { id: 'd8-0', type: 'stay', time: '09:00', title: '出發：Dormy Inn 甲府', desc: '辦理退房。', nav: 'Dormy Inn Kofu Marunouchi', highlight: '', travelInfo: '40km | 50分' },
                    { 
                        id: 'd8-1', type: 'sight', time: '10:00', title: '河口湖 大石公園', 
                        desc: '位於河口湖北岸，是眺望「富士山與河口湖」經典構圖的絕佳位置。這裡最著名的是夏季的薰衣草與秋季的掃帚草，但在冬季，這裡擁有極高的「富士山能見度」。冬日的空氣乾燥澄澈，富士山頂的積雪最為厚實完美，您可以在此拍出最清晰、無遮蔽的富士山全景。園區內的「河口湖自然生活館」販售藍莓霜淇淋與多種富士山周邊商品。早晨逆光較強，建議上午稍晚或下午前往，光線會更適合拍照。', 
                        nav: 'Oishi Park', highlight: '最佳拍照點', travelInfo: '10km | 20分' 
                    },
                    { 
                        id: 'd8-2', type: 'food', time: '11:30', title: '午餐：吉田烏龍麵', 
                        desc: '富士吉田市的在地庶民美食，以「全日本最硬」的麵條著稱。', 
                        nav: 'Kuranosuke', highlight: '推薦：蔵ノ介', travelInfo: '50km | 1小時15分' 
                    },
                    { 
                        id: 'd8-3', type: 'sight', time: '14:00', title: '箱根神社 & 平和鳥居', 
                        desc: '箱根神社擁有超過1200年的歷史，是關東地區著名的能量景點（Power Spot），許多政商名流與武將皆曾來此祈願。神社隱身於茂密的杉木林中，氛圍神聖。最知名的地標是矗立在蘆之湖水面上的紅色「平和的鳥居」，在湖光山色的映襯下極具神祕感，是箱根最熱門的打卡點。若要在此拍照通常需要排隊。參拜後，可以沿著湖畔步道散策，感受箱根特有的靈氣與靜謐。', 
                        nav: 'Hakone Shrine', highlight: '經御殿場、仙石原', travelInfo: '20km | 40分 (下坡)' 
                    },
                    { 
                        id: 'd8-4', type: 'stay', time: '17:00', title: '小田原 住宿', 
                        desc: '小田原是新幹線停靠站也是箱根門戶，住宿選擇多樣。若預算許可，推薦車站直結的「天成園 小田原站別館」，擁有高空足湯與優質客房；若追求CP值，車站周邊也有多間商務旅館。住在小田原的優勢在於房價比箱根溫泉區親民許多，且晚餐選擇豐富，車站旁有「Minaka小田原」複合設施，充滿江戶風情且美食眾多。這裡距離隔天要去的鎌倉與江之島交通也非常順暢。', 
                        nav: 'Odawara Station', highlight: '', travelInfo: '步行' 
                    },
                    { 
                        id: 'd8-5', type: 'food', time: '18:00', title: '晚餐：小田原關東煮', 
                        desc: '小田原是著名的魚板產地，利用當地豐富的漁獲製作的關東煮自然不同凡響。', 
                        nav: 'Odawara Oden Honten', highlight: '需預約' 
                    }
                ]
            },
            {
                id: 'day9', dayLabel: 'Day 9', date: '2/16 (一)', title: '江之島與橫濱夜景', location: '小田原 -> 橫濱',
                coords: { lat: 35.3192, lon: 139.5467 },
                events: [
                    { id: 'd9-0', type: 'stay', time: '09:30', title: '出發：小田原', desc: '辦理退房，前往小田原城。', nav: 'Odawara Station', highlight: '', travelInfo: '短程' },
                    { 
                        id: 'd9-1', type: 'sight', time: '10:00', title: '小田原城', 
                        desc: '難攻不落的戰國名城，曾是關東霸主北條氏五代的居城。現在的天守閣是昭和時代復原的，內部設有歷史博物館，展示甲冑、刀劍與北條氏的歷史故事。登上天守閣頂層，可以360度眺望相模灣的大海與箱根群山，視野極佳。2月份正好是城址公園內的梅花季節，小田原城的梅花與天守閣相映成趣，景色雅緻。此外，這裡也設有忍者體驗館，非常適合喜歡歷史與戰國文化的遊客。', 
                        nav: 'Odawara Castle', highlight: '天守閣', travelInfo: '30km | 50分 (海岸)' 
                    },
                    { 
                        id: 'd9-2', type: 'food', time: '12:30', title: '午餐：Coral Reef', 
                        desc: '在國道134號沿線的知名海景餐廳享用午餐。', 
                        nav: 'Coral Reef Moana Makai', highlight: '海景餐廳', travelInfo: '5km | 15分' 
                    },
                    { 
                        id: 'd9-3', type: 'sight', time: '14:00', title: '鎌倉高校前 (灌籃高手)', 
                        desc: '江之島電鐵（江ノ電）的一個小車站，卻因為動畫《灌籃高手》片頭曲中，櫻木花道與晴子揮手的平交道場景而聞名世界。這裡擁有「碧海、藍天、綠色電車」的完美畫面，在此拍照能重溫青春回憶。由於遊客眾多，建議遵守交通規則，不要站在馬路中間拍照。除了平交道，車站本身的月台就面對著七里濱海岸，在此等車看海，感受湘南海岸的陽光與海風，本身就是一種享受。', 
                        nav: 'Kamakurakokomae Station', highlight: '灌籃高手平交道', travelInfo: '3km | 10分' 
                    },
                    { 
                        id: 'd9-4', type: 'sight', time: '14:30', title: '江之島深度遊', 
                        desc: '江之島是湘南海岸的地標，透過跨海大橋與陸地相連。深度遊建議購買「江之島1day周遊券（eno=pass）」，可利用手扶梯（ESCAR）輕鬆攻頂。島上有歷史悠久的江島神社（供奉弁財天，求財與演藝運）、充滿南洋風情的「山姆繆爾·科金苑」以及地標展望台「Sea Candle」，冬季夜晚會有盛大的點燈活動「湘南寶石」。島嶼最深處的「岩屋」海蝕洞充滿神祕氣氛，回程若不想走路，可搭乘「弁天丸」遊覽船直接回到橋頭，從海上欣賞江之島全貌。', 
                        nav: 'Enoshima', highlight: '神社/燈塔/水族館', travelInfo: '30km | 1小時' 
                    },
                    { 
                        id: 'd9-5', type: 'transport', time: '17:00', title: '前往橫濱', 
                        desc: '避開最晚的下班車潮，前往橫濱。', 
                        nav: 'Toyoko Inn Yokohama Stadium Mae No.1', highlight: '前往飯店', travelInfo: '市區 | 10分' 
                    },
                    { 
                        id: 'd9-6', type: 'stay', time: '18:00', title: '東橫INN 橫濱體育場前', 
                        desc: '位於橫濱的精華地段，就在橫濱球場（DeNA海灣之星主場）正對面，距離中華街步行僅需3分鐘，距離紅磚倉庫與山下公園也在步行範圍內。雖然位於熱鬧區域，但飯店內部維持一貫的安靜與整潔。這裡是這趟旅程的最後一站，地理位置極佳，方便您在check-in後步行去中華街吃晚餐，或去港區看夜景。雖然停車位可能較滿，但周邊有許多大型公共停車場可供選擇。', 
                        nav: 'Toyoko Inn Yokohama Stadium Mae No.1', highlight: 'Check-in', travelInfo: '計程車/步行' 
                    },
                    { 
                        id: 'd9-7', type: 'sight', time: '18:40', title: 'YOKOHAMA AIR CABIN', 
                        desc: '日本首座常設都市型纜車，連接JR櫻木町站前與運河公園（紅磚倉庫附近）。雖然單程僅約5分鐘，但它提供了前所未有的視角來欣賞橫濱港未來（Minato Mirai）的景色。纜車車廂設計現代且擁有大片玻璃窗，白天可俯瞰運河與遊步道，夜晚則能穿梭在摩天輪與大樓群的璀璨燈火之中，極具未來感。這不僅是交通工具，更是一個移動的觀景台，能大幅節省從車站走到紅磚倉庫的體力。', 
                        nav: 'YOKOHAMA AIR CABIN', highlight: '橫濱夜景', travelInfo: '步行/短程' 
                    },
                    { 
                        id: 'd9-8', type: 'food', time: '19:10', title: '晚餐：橫濱中華街', 
                        desc: '纜車下車後，直接搭車或散步回中華街享用晚餐。', 
                        nav: 'Yokohama Chinatown', highlight: '中華料理' 
                    }
                ]
            },
            {
                id: 'day10', dayLabel: 'Day 10', date: '2/17 (二)', title: '歸途', location: '橫濱 -> 成田',
                coords: { lat: 35.7719, lon: 140.3929 },
                events: [
                    { id: 'd10-0', type: 'stay', time: '09:00', title: '出發：東橫INN 橫濱', desc: '辦理退房，前往機場。', nav: 'Toyoko Inn Yokohama Stadium Mae No.1', highlight: '檢查護照/行李', travelInfo: '90km | 1.5小時' },
                    { id: 'd10-1', type: 'transport', time: '09:00', title: '前往成田機場', desc: '預留充裕時間還車。', nav: 'Narita International Airport', highlight: '還車期限：13:00前', travelInfo: '機場內' },
                    { id: 'd10-2', type: 'transport', time: '13:00', title: '還車 & 登機', desc: 'Toyota Rent a Car 成田機場店還車。', nav: 'Toyota Rent a Car Narita Airport', highlight: '星宇航空 JX801' }
                ]
            }
        ];

        // --- Utils & Services ---
        
        // 1. 壓縮圖片 (縮小尺寸但轉為 Blob 方便上傳)
        const compressImageToBlob = (file, maxWidth = 800, quality = 0.7) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // 轉為 Blob 格式 (比 Base64 字串更好上傳)
                        canvas.toBlob((blob) => {
                            if (blob) resolve(blob);
                            else reject(new Error("Canvas to Blob failed"));
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        };

        const ensureAuth = async () => {
            if (!window.auth) throw new Error("Firebase auth not initialized");
            if (window.auth.currentUser) return window.auth.currentUser.uid;
            const cred = await window.firebaseModules.signInAnonymously(window.auth);
            return cred.user.uid;
        };

        const subscribeToUserData = (callback) => {
            if (!window.auth || !window.auth.currentUser) return () => {};
            const { collection, onSnapshot } = window.firebaseModules;
            // UPDATE: 使用共用路徑 trips/shared_kanto_2026/events，而非個人路徑
            const eventsRef = collection(window.db, `trips/${SHARED_TRIP_ID}/events`);
            return onSnapshot(eventsRef, (snapshot) => {
                const data = {};
                snapshot.forEach((doc) => {
                    data[doc.id] = doc.data();
                });
                callback(data);
            });
        };

        const saveEventData = async (eventId, data) => {
            const { doc, setDoc } = window.firebaseModules;
            await ensureAuth(); // 確保有登入
            // UPDATE: 寫入共用路徑
            const docRef = doc(window.db, `trips/${SHARED_TRIP_ID}/events`, eventId);
            await setDoc(docRef, data, { merge: true });
        };

        // NEW: Upload to Firebase Storage
        const uploadPhotoToStorage = async (file) => {
            const { ref, uploadBytes, getDownloadURL } = window.firebaseModules;
            await ensureAuth();
            
            // 1. 壓縮圖片
            const blob = await compressImageToBlob(file);
            
            // 2. 建立儲存路徑 (trips/shared_kanto_2026/{timestamp}.jpg)
            // UPDATE: Storage 也改成共用路徑，方便管理
            const filename = `${Date.now()}.jpg`;
            const storageRef = ref(window.storage, `trips/${SHARED_TRIP_ID}/${filename}`);
            
            // 3. 上傳
            await uploadBytes(storageRef, blob);
            
            // 4. 取得公開下載連結
            const url = await getDownloadURL(storageRef);
            return url;
        };

        const subscribeToBudget = (callback) => {
            if (!window.auth || !window.auth.currentUser) return () => {};
            const { collection, onSnapshot } = window.firebaseModules;
            // UPDATE: 使用共用路徑
            const budgetRef = collection(window.db, `trips/${SHARED_TRIP_ID}/budget`);
            return onSnapshot(budgetRef, (snapshot) => {
                const items = [];
                snapshot.forEach((doc) => {
                    items.push({ id: Number(doc.id), ...doc.data() });
                });
                callback(items);
            });
        };

        const addBudgetItem = async (item) => {
            const { doc, setDoc } = window.firebaseModules;
            await ensureAuth();
            // UPDATE: 使用共用路徑
            const docRef = doc(window.db, `trips/${SHARED_TRIP_ID}/budget`, item.id.toString());
            await setDoc(docRef, { desc: item.desc, cost: item.cost });
        };

        const deleteBudgetItem = async (itemId) => {
            const { doc, deleteDoc } = window.firebaseModules;
            await ensureAuth();
            // UPDATE: 使用共用路徑
            const docRef = doc(window.db, `trips/${SHARED_TRIP_ID}/budget`, itemId.toString());
            await deleteDoc(docRef);
        };

        // --- Components ---

        const WeatherWidget = ({ coords }) => {
            const [weather, setWeather] = useState(null);

            useEffect(() => {
                if(coords) {
                    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current_weather=true&timezone=Asia%2FTokyo`)
                        .then(res => res.json())
                        .then(data => setWeather(data.current_weather))
                        .catch(e => console.error("Weather fetch failed", e));
                }
            }, [coords]);

            if (!weather) return <div className="text-xs text-gray-500 flex items-center gap-1"><div className="spinner"></div> 載入天氣...</div>;

            const weatherCodes = {
                0: { label: '晴朗', icon: 'fa-sun', color: 'text-orange-400' },
                1: { label: '多雲', icon: 'fa-cloud-sun', color: 'text-yellow-200' },
                2: { label: '陰天', icon: 'fa-cloud', color: 'text-gray-400' },
                3: { label: '陰天', icon: 'fa-cloud', color: 'text-gray-400' },
                45: { label: '霧', icon: 'fa-smog', color: 'text-gray-300' },
                48: { label: '霧淞', icon: 'fa-snowflake', color: 'text-white' },
                51: { label: '細雨', icon: 'fa-cloud-rain', color: 'text-blue-300' },
                61: { label: '下雨', icon: 'fa-umbrella', color: 'text-blue-400' },
                71: { label: '下雪', icon: 'fa-snowflake', color: 'text-white' },
                80: { label: '陣雨', icon: 'fa-cloud-showers-heavy', color: 'text-blue-500' },
                95: { label: '雷雨', icon: 'fa-bolt', color: 'text-yellow-400' },
            };
            const wCode = weatherCodes[weather.weathercode] || weatherCodes[0];
            
            return (
                <div className="flex items-center gap-2 bg-black/40 px-3 py-1 rounded-full border border-white/10 backdrop-blur-md shadow-lg">
                    <i className={`fas ${wCode.icon} ${wCode.color} text-lg`}></i>
                    <div className="flex flex-col leading-none">
                        <span className="text-lg font-bold text-white">{weather.temperature}<span className="text-xs font-normal">°C</span></span>
                        <span className="text-[10px] text-gray-300">{wCode.label}</span>
                    </div>
                </div>
            );
        };

        const InfoTool = () => (
             <div className="space-y-4 animation-fade-in">
                <div className="bg-jp-dark p-4 rounded-xl shadow-lg border-l-4 border-blue-500">
                    <h3 className="text-white font-bold mb-2 flex items-center"><i className="fas fa-plane mr-2 text-blue-400"></i>航班資訊</h3>
                    <div className="space-y-3 text-sm text-gray-300">
                        <div className="flex justify-between items-center bg-black/20 p-2 rounded">
                            <div><span className="block text-white font-bold">GK14</span> <span className="text-xs">2/8 去程</span></div>
                            <div className="text-right"><span className="block text-white">12:50 TPE</span><span className="block text-white">16:55 NRT</span></div>
                        </div>
                        <div className="flex justify-between items-center bg-black/20 p-2 rounded">
                            <div><span className="block text-white font-bold">JX801</span> <span className="text-xs">2/17 回程</span></div>
                            <div className="text-right"><span className="block text-white">13:40 NRT</span><span className="block text-white">16:45 TPE</span></div>
                        </div>
                    </div>
                </div>
                <div className="bg-jp-dark p-4 rounded-xl shadow-lg border-l-4 border-purple-500">
                    <h3 className="text-white font-bold mb-2 flex items-center"><i className="fas fa-hotel mr-2 text-purple-400"></i>住宿清單</h3>
                    <div className="text-sm text-gray-300 space-y-2 max-h-60 overflow-y-auto">
                        <div className="flex justify-between border-b border-gray-700 pb-1"><span>2/8</span> <span className="text-white">東橫INN 成田機場</span></div>
                        <div className="flex justify-between border-b border-gray-700 pb-1"><span>2/9</span> <span className="text-white">Dormy Inn 水戶</span></div>
                        <div className="flex justify-between border-b border-gray-700 pb-1"><span>2/10</span> <span className="text-white">東橫INN 宇都宮</span></div>
                        <div className="flex justify-between border-b border-gray-700 pb-1"><span>2/11</span> <span className="text-white">坂戶城 (六日町)</span></div>
                        <div className="flex justify-between border-b border-gray-700 pb-1"><span>2/12</span> <span className="text-white">東橫INN 新潟</span></div>
                        <div className="flex justify-between border-b border-gray-700 pb-1"><span>2/13</span> <span className="text-white">東橫INN 長野</span></div>
                        <div className="flex justify-between border-b border-gray-700 pb-1"><span>2/14</span> <span className="text-white">Dormy Inn 甲府</span></div>
                        <div className="flex justify-between border-b border-gray-700 pb-1"><span>2/15</span> <span className="text-white">小田原 住宿</span></div>
                        <div className="flex justify-between border-b border-gray-700 pb-1"><span>2/16</span> <span className="text-white">東橫INN 橫濱</span></div>
                    </div>
                </div>
                <div className="bg-jp-dark p-4 rounded-xl shadow-lg border-l-4 border-red-500">
                    <h3 className="text-white font-bold mb-2 flex items-center"><i className="fas fa-phone mr-2 text-red-400"></i>緊急聯絡</h3>
                    <div className="grid grid-cols-2 gap-3 text-sm">
                        <a href="tel:110" className="bg-red-900/40 py-2 rounded text-center block hover:bg-red-900/60 transition-colors">警察 110</a>
                        <a href="tel:119" className="bg-red-900/40 py-2 rounded text-center block hover:bg-red-900/60 transition-colors">救護 119</a>
                        <div className="col-span-2 bg-gray-700/40 p-2 rounded text-center text-xs">
                            外交部旅外急難救助：+81-80-1009-7179
                        </div>
                    </div>
                </div>
            </div>
        );

        const BudgetTool = () => {
            const [items, setItems] = useState([]);
            const [newItem, setNewItem] = useState({ desc: '', cost: '' });
            const [total, setTotal] = useState(0);

            useEffect(() => {
                const unsubscribe = subscribeToBudget((updatedItems) => {
                    setItems(updatedItems.sort((a, b) => b.id - a.id));
                });
                return () => { if(typeof unsubscribe === 'function') unsubscribe(); }
            }, []);

            useEffect(() => {
                const sum = items.reduce((acc, item) => acc + Number(item.cost), 0);
                setTotal(sum);
            }, [items]);

            const handleAddItem = async () => {
                if (!newItem.desc || !newItem.cost) return;
                const item = {
                    id: Date.now(),
                    desc: newItem.desc,
                    cost: newItem.cost
                };
                await addBudgetItem(item);
                setNewItem({ desc: '', cost: '' });
            };

            return (
                <div className="bg-jp-dark p-4 rounded-xl shadow-lg card-shadow animation-fade-in border border-white/5">
                    <h3 className="text-jp-gold font-bold mb-4 flex items-center justify-between">
                        <span><i className="fas fa-wallet mr-2"></i>旅費記帳 (雲端共用)</span>
                        <span className="text-2xl font-mono">¥{total.toLocaleString()}</span>
                    </h3>
                    <div className="flex gap-2 mb-4">
                        <input 
                            type="text" 
                            placeholder="項目 (如: 拉麵)" 
                            className="flex-[2] p-3 text-sm bg-black/40 border-gray-700 rounded-lg focus:border-jp-gold transition-colors text-white"
                            value={newItem.desc}
                            onChange={e => setNewItem({...newItem, desc: e.target.value})}
                        />
                        <input 
                            type="number" 
                            placeholder="¥" 
                            className="flex-1 p-3 text-sm bg-black/40 border-gray-700 rounded-lg focus:border-jp-gold transition-colors text-white"
                            value={newItem.cost}
                            onChange={e => setNewItem({...newItem, cost: e.target.value})}
                        />
                        <button onClick={handleAddItem} className="bg-jp-gold text-black px-4 rounded-lg font-bold hover:bg-yellow-500 shadow-lg shadow-yellow-600/20 active:scale-95 transition-all">
                            <i className="fas fa-plus"></i>
                        </button>
                    </div>
                    <div className="max-h-60 overflow-y-auto space-y-2 pr-1">
                        {items.map(item => (
                            <div key={item.id} className="flex justify-between items-center p-3 bg-white/5 rounded-lg border border-white/5 text-sm hover:bg-white/10 transition-colors">
                                <span className="text-white">{item.desc}</span>
                                <div className="flex items-center gap-3">
                                    <span className="font-mono text-gray-300">¥{Number(item.cost).toLocaleString()}</span>
                                    <button onClick={() => deleteBudgetItem(item.id)} className="text-red-500 w-6 h-6 flex items-center justify-center bg-red-500/10 rounded-full hover:bg-red-500/30">
                                        <i className="fas fa-times text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        ))}
                        {items.length === 0 && <div className="text-center text-gray-600 py-4 text-xs italic">尚未新增消費紀錄</div>}
                    </div>
                </div>
            );
        };

        const CardModal = ({ event, userData, onClose }) => {
            const fileInputRef = useRef(null);
            const [isUploading, setIsUploading] = useState(false);
            
            const handlePhotoUpload = async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                setIsUploading(true);
                try {
                    // Upload to Storage
                    const photoUrl = await uploadPhotoToStorage(file);
                    
                    const currentPhotos = userData?.photos || [];
                    const newPhotos = [...currentPhotos, photoUrl];
                    await saveEventData(event.id, { ...userData, photos: newPhotos });
                } catch (error) {
                    console.error("Upload failed", error);
                    // Catch storage bucket missing error
                    if (error.code === 'storage/object-not-found' || error.message.includes('bucket')) {
                         alert("上傳失敗：請檢查 Firebase Console 是否已開啟 Storage 功能。\n(錯誤代碼: bucket-error)");
                    } else if (error.code === 'storage/unauthorized' || error.code === 'permission-denied') {
                         alert("上傳失敗：權限不足。請到 Firebase Console 更新 Rules，允許 trips/ 路徑的讀寫。");
                    } else {
                         alert("照片上傳失敗，請稍後再試。");
                    }
                } finally {
                    setIsUploading(false);
                }
            };

            const handleNoteChange = async (val) => {
                await saveEventData(event.id, { ...userData, notes: val });
            };

            const handleDeletePhoto = async (idxToDelete) => {
                if(!userData?.photos) return;
                const newPhotos = userData.photos.filter((_, i) => i !== idxToDelete);
                await saveEventData(event.id, { ...userData, photos: newPhotos });
            }

            const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(event.nav)}`;
            const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(event.nav)}`;
            const headerColor = {
                transport: 'bg-jp-indigo', sight: 'bg-jp-red', food: 'bg-jp-gold', stay: 'bg-purple-600'
            }[event.type] || 'bg-gray-600';

            return (
                <div className="fixed inset-0 z-[60] flex flex-col bg-[#121212] animation-slide-up">
                    <div className="relative h-64 shrink-0 bg-gray-800">
                        {userData?.photos && userData.photos.length > 0 ? (
                            <img src={userData.photos[0]} className="w-full h-full object-cover opacity-80" alt="Cover" />
                        ) : (
                            <div className={`w-full h-full ${headerColor} opacity-50 flex items-center justify-center`}>
                                <i className={`fas fa-image text-4xl text-white/30`}></i>
                            </div>
                        )}
                        <button onClick={onClose} className="absolute top-4 right-4 z-10 w-10 h-10 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black/70 backdrop-blur">
                            <i className="fas fa-times text-lg"></i>
                        </button>
                        <div className="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-[#121212] to-transparent">
                            <span className="inline-block px-2 py-0.5 rounded bg-white/20 text-white text-xs mb-2 backdrop-blur-sm border border-white/20">
                                {event.time}
                            </span>
                            <h2 className="text-3xl font-bold text-white leading-tight shadow-black drop-shadow-md">{event.title}</h2>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 pb-24">
                        <div className="flex gap-3 mb-6">
                            <a href={navUrl} target="_blank" rel="noopener noreferrer" className="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-blue-900/50 active:scale-95 transition-transform no-underline">
                                <i className="fas fa-location-arrow"></i> 導航
                            </a>
                             <a href={searchUrl} target="_blank" rel="noopener noreferrer" className="flex-1 bg-gray-700 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform no-underline">
                                <i className="fab fa-google"></i> 搜尋
                            </a>
                        </div>
                        <div className="mb-6">
                            <h3 className="text-jp-gold text-sm font-bold uppercase tracking-wider mb-2">關於此地</h3>
                            <p className="text-gray-300 leading-relaxed text-lg whitespace-pre-line">{event.desc}</p>
                        </div>
                        {event.highlight && (
                            <div className="mb-6 p-4 bg-jp-gold/10 border-l-4 border-jp-gold rounded-r-lg">
                                <h3 className="text-jp-gold text-sm font-bold mb-1"><i className="fas fa-lightbulb mr-2"></i>攻略筆記</h3>
                                <p className="text-gray-200">{event.highlight}</p>
                                {event.subInfo && <p className="text-gray-400 text-sm mt-1">{event.subInfo}</p>}
                            </div>
                        )}
                        <div className="mb-8">
                            <h3 className="text-jp-gold text-sm font-bold uppercase tracking-wider mb-2">我的備註</h3>
                            <textarea 
                                className="w-full bg-gray-800 text-white p-4 rounded-xl border border-gray-700 focus:border-jp-gold min-h-[120px] text-base"
                                placeholder="寫下旅行心情或備忘錄 (全體成員可見)..."
                                defaultValue={userData?.notes || ''}
                                onBlur={(e) => handleNoteChange(e.target.value)}
                            />
                        </div>
                        <div>
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-jp-gold text-sm font-bold uppercase tracking-wider">相簿 ({userData?.photos?.length || 0})</h3>
                                <button 
                                    onClick={() => fileInputRef.current?.click()}
                                    disabled={isUploading}
                                    className="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm text-white transition-colors border border-gray-700 flex items-center"
                                >
                                     {isUploading ? <span className="spinner mr-2"></span> : <i className="fas fa-camera mr-2"></i>}
                                     {isUploading ? '處理中...' : '新增照片'}
                                </button>
                                <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handlePhotoUpload} />
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                {userData?.photos?.map((photo, idx) => (
                                    <div key={idx} className="aspect-square rounded-xl bg-gray-800 overflow-hidden relative group shadow-lg">
                                        <img src={photo} className="w-full h-full object-cover" alt={`Upload ${idx}`} />
                                        <button 
                                            className="absolute top-2 right-2 bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center shadow-lg"
                                            onClick={() => handleDeletePhoto(idx)}
                                        >
                                            <i className="fas fa-trash text-sm"></i>
                                        </button>
                                    </div>
                                ))}
                                {(!userData?.photos || userData.photos.length === 0) && (
                                    <div className="col-span-2 py-8 text-center text-gray-600 border-2 border-dashed border-gray-800 rounded-xl">
                                        尚無照片，點擊新增按鈕上傳
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Card = ({ event, userData, onOpenModal }) => {
            const hasCover = userData?.photos && userData.photos.length > 0;
            const coverImage = hasCover ? userData?.photos?.[0] : null;
            const styles = {
                transport: { icon: 'fa-car', color: 'text-jp-indigo', border: 'border-jp-indigo' },
                sight: { icon: 'fa-torii-gate', color: 'text-jp-red', border: 'border-jp-red' },
                food: { icon: 'fa-utensils', color: 'text-jp-gold', border: 'border-jp-gold' },
                stay: { icon: 'fa-bed', color: 'text-purple-400', border: 'border-purple-500' }
            }[event.type] || { icon: 'fa-circle', color: 'text-gray-400', border: 'border-gray-500' };
            const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(event.nav)}`;

            return (
                <div className="relative pl-4 pb-8 group">
                    <div className="absolute left-[19px] top-8 bottom-0 w-0.5 bg-gray-800 group-last:hidden"></div>
                    <div 
                        onClick={onOpenModal}
                        className={`relative rounded-xl overflow-hidden shadow-lg bg-jp-dark active:scale-[0.98] transition-all duration-200 cursor-pointer border-l-4 ${styles.border}`}
                    >
                        {hasCover && coverImage && (
                            <div className="absolute inset-0 z-0">
                                <img src={coverImage} className="w-full h-full object-cover opacity-60" alt="Cover" />
                                <div className="absolute inset-0 card-bg-gradient"></div>
                            </div>
                        )}
                        <div className="relative z-10 p-4">
                            <div className="flex items-start gap-3">
                                <div className={`mt-0.5 w-8 h-8 rounded-full flex items-center justify-center bg-black/40 backdrop-blur-sm border border-white/10 shrink-0`}>
                                    <i className={`fas ${styles.icon} ${hasCover ? 'text-white' : styles.color}`}></i>
                                </div>
                                <div className="flex-1 min-w-0">
                                    <div className="flex justify-between items-start">
                                        <span className={`text-xs font-mono tracking-wide ${hasCover ? 'text-gray-200' : 'text-gray-400'}`}>{event.time}</span>
                                        <a 
                                            href={navUrl} 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            onClick={(e) => e.stopPropagation()} 
                                            className="px-2 py-1 rounded bg-blue-600/30 hover:bg-blue-600/50 text-blue-300 text-xs flex items-center gap-1 border border-blue-500/30"
                                        >
                                            <i className="fas fa-location-arrow text-[10px]"></i> 導航
                                        </a>
                                    </div>
                                    <h3 className={`text-lg font-bold mb-1 truncate ${hasCover ? 'text-white shadow-black drop-shadow-md' : 'text-jp-light'}`}>{event.title}</h3>
                                    <p className={`text-sm line-clamp-2 ${hasCover ? 'text-gray-200' : 'text-gray-400'}`}>{event.desc}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {event.travelInfo && (
                         <div className="absolute left-[38px] bottom-[2px] transform translate-y-1/2 z-0 pl-4 w-full">
                            <div className="flex items-center gap-2">
                                <div className="h-[1px] w-4 bg-gray-700 shrink-0"></div>
                                <div className="flex items-center bg-gray-800 text-gray-300 px-2 py-1 rounded-full border border-gray-700 shadow-sm max-w-[85%]">
                                    <i className="fas fa-car text-[10px] mr-2 text-gray-400 shrink-0"></i>
                                    <span className="text-[10px] whitespace-nowrap font-mono overflow-hidden text-ellipsis">{event.travelInfo}</span>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [selectedDayId, setSelectedDayId] = useState('day1');
            const [userDataStore, setUserDataStore] = useState({});
            const [modalData, setModalData] = useState(null);
            const [activeTab, setActiveTab] = useState('itinerary');
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                const initAuthAndSync = async () => {
                     try {
                        if (!window.db) {
                            await new Promise(r => setTimeout(r, 1000));
                            if (!window.db) throw new Error("Firebase not initialized in window");
                        }

                        await ensureAuth();
                        const unsubscribe = subscribeToUserData((data) => {
                            setUserDataStore(data);
                            setIsLoading(false);
                        });
                        return unsubscribe;
                     } catch (e) {
                         console.error("Auth/Sync failed", e);
                         setIsLoading(false);
                         if (e.code === 'auth/configuration-not-found' || e.code === 'auth/operation-not-allowed') {
                             setError({
                                title: "尚未啟用匿名登入",
                                message: "Firebase Authentication 的「匿名登入」功能尚未開啟。",
                                code: 'AUTH_CONFIG'
                             });
                         } else if (e.code === 'permission-denied') {
                             setError({
                                title: "權限不足",
                                message: "請檢查 Firestore Rules 是否已允許 'trips' 資料夾的讀寫權限。",
                                code: 'PERMISSION'
                             });
                         } else {
                             setError({
                                title: "資料庫連線錯誤",
                                message: e.message || "未知錯誤",
                             });
                         }
                     }
                };
                initAuthAndSync();
            }, []);

            if (error) {
                return (
                    <div className="min-h-screen bg-[#121212] flex flex-col items-center justify-center p-8 text-center text-white font-sans">
                        <div className="w-16 h-16 rounded-full bg-red-900/50 flex items-center justify-center mb-4 text-red-400 text-3xl border border-red-500/30">
                            <i className="fas fa-exclamation-triangle"></i>
                        </div>
                        <h2 className="text-xl font-bold mb-2 text-white">{error.title}</h2>
                        <p className="text-gray-400 mb-6 max-w-md leading-relaxed text-sm whitespace-pre-line">{error.message}</p>
                        
                        {error.code === 'PERMISSION' && (
                             <div className="bg-gray-800 p-6 rounded-xl text-left text-sm text-gray-300 w-full max-w-md border-l-4 border-jp-gold shadow-xl my-4">
                                <h3 className="font-bold text-white mb-3 text-base flex items-center"><i className="fas fa-wrench mr-2 text-jp-gold"></i>如何修復？</h3>
                                <p className="mb-2">資料庫位置已更改為共用群組，請更新 Firestore Rules：</p>
                                <pre className="bg-black/50 p-2 rounded text-xs font-mono text-green-400 overflow-x-auto">
match /trips/{'{'}tripId{'}'}/{'{'}document=**{'}'} {'{'} <br/>
&nbsp;&nbsp;allow read, write: if request.auth != null; <br/>
{'}'}
                                </pre>
                            </div>
                        )}

                        <button onClick={() => window.location.reload()} className="mt-8 px-6 py-3 bg-jp-gold text-black font-bold rounded-lg hover:bg-yellow-500 transition-colors">
                            <i className="fas fa-sync-alt mr-2"></i>重試
                        </button>
                    </div>
                );
            }

            const currentDay = INITIAL_ITINERARY.find(d => d.id === selectedDayId);
            if (!currentDay) return null;

            return (
                <div className="min-h-screen bg-[#121212] pb-20 relative font-sans text-jp-light">
                    <div className="sticky top-0 z-40 bg-[#121212]/90 backdrop-blur-md border-b border-white/5 pt-env-top">
                        <div className="px-4 py-3 flex justify-between items-center">
                            <div>
                                <h1 className="text-white font-bold tracking-widest text-lg">2026 關東自駕</h1>
                                <p className="text-xs text-gray-400 flex items-center gap-1">
                                    <i className="fas fa-map-marker-alt text-jp-red"></i> {currentDay.location.split(' ')[0]}
                                    {isLoading && <span className="ml-2 spinner w-3 h-3"></span>}
                                </p>
                            </div>
                            {activeTab === 'itinerary' && (
                                <WeatherWidget coords={currentDay.coords} />
                            )}
                        </div>
                        {activeTab === 'itinerary' && (
                            <div className="flex overflow-x-auto hide-scrollbar gap-2 px-4 pb-3">
                                {INITIAL_ITINERARY.map(day => (
                                    <button
                                        key={day.id}
                                        onClick={() => setSelectedDayId(day.id)}
                                        className={`flex-shrink-0 px-4 py-2 rounded-lg text-sm transition-all border ${
                                            selectedDayId === day.id 
                                            ? 'bg-jp-red text-white border-jp-red shadow-lg shadow-red-900/40' 
                                            : 'bg-jp-dark text-gray-400 border-gray-700'
                                        }`}
                                    >
                                        <span className="block text-[10px] opacity-70 mb-0.5">{day.date}</span>
                                        <span className="font-bold">{day.dayLabel}</span>
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>
                    <div className="p-4 pt-6">
                         {activeTab === 'itinerary' ? (
                            <div className="animation-fade-in pb-12">
                                {currentDay.events.map(event => (
                                    <Card 
                                        key={event.id} 
                                        event={event} 
                                        userData={userDataStore[event.id]}
                                        onOpenModal={() => setModalData(event)}
                                    />
                                ))}
                            </div>
                         ) : (
                             <div className="space-y-6 pb-12">
                                <InfoTool />
                                <BudgetTool />
                                <div className="text-center text-xs text-gray-600 mt-8">
                                    <p>資料同步至 Firebase Firestore (共用群組)</p>
                                    <p>照片儲存於 Firebase Storage (共用群組)</p>
                                </div>
                             </div>
                         )}
                    </div>
                    {modalData && (
                        <CardModal 
                            event={modalData}
                            userData={userDataStore[modalData.id]}
                            onClose={() => setModalData(null)}
                        />
                    )}
                    <div className="fixed bottom-0 left-0 right-0 glass-panel border-t border-white/10 pb-env-bottom z-50">
                        <div className="flex justify-around items-center h-16">
                            <button onClick={() => setActiveTab('itinerary')} className={`${activeTab === 'itinerary' ? 'text-jp-gold' : 'text-gray-500'} flex flex-col items-center w-full active:scale-95 transition-transform`}>
                                <i className="fas fa-route text-xl mb-1"></i><span className="text-[10px]">行程</span>
                            </button>
                            <button onClick={() => setActiveTab('tools')} className={`${activeTab === 'tools' ? 'text-jp-gold' : 'text-gray-500'} flex flex-col items-center w-full active:scale-95 transition-transform`}>
                                <i className="fas fa-toolbox text-xl mb-1"></i><span className="text-[10px]">工具</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
