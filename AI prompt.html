<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æç¤ºè©åº« (ç„¡é™å®¹é‡ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6; padding-bottom: 100px; }
        .card-img { width: 100%; height: auto; max-height: 300px; object-fit: contain; background: #000; border-radius: 8px 8px 0 0; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 100; }
        .toast.show { opacity: 1; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3498db; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-left: 10px; display: none;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="bg-indigo-600 text-white p-4 shadow-md sticky top-0 z-10 flex justify-between items-center">
        <h1 class="text-lg font-bold">ğŸš€ AI è©åº« (Pro)</h1>
        <div class="space-x-1">
            <button onclick="exportData()" class="bg-indigo-500 hover:bg-indigo-400 text-white text-xs px-3 py-2 rounded border border-indigo-400">â¬‡ å‚™ä»½</button>
            <button onclick="document.getElementById('import-file').click()" class="bg-indigo-500 hover:bg-indigo-400 text-white text-xs px-3 py-2 rounded border border-indigo-400">â¬† é‚„åŸ</button>
            <input type="file" id="import-file" style="display: none;" onchange="importData(this)">
        </div>
    </div>

    <div id="app" class="p-4 max-w-md mx-auto space-y-4">
        <div id="loading-state" class="text-center text-gray-500 mt-10">è³‡æ–™è®€å–ä¸­...</div>
        <div id="empty-state" class="text-center text-gray-400 mt-10 hidden">
            <p>ç›®å‰æ²’æœ‰è³‡æ–™</p>
            <p class="text-sm mt-2">å®¹é‡å·²è§£é–ï¼Œç›¡æƒ…å„²å­˜å§ï¼</p>
        </div>
    </div>

    <div class="fixed bottom-6 right-6">
        <button onclick="openModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg text-3xl font-bold">+</button>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg w-full max-w-md p-6 shadow-xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">æ–°å¢æç¤ºè©</h2>
            
            <label class="block text-sm font-medium text-gray-700 mb-1">é¸æ“‡åœ–ç‰‡</label>
            <div class="flex items-center space-x-2 mb-4">
                <label class="cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-md border border-gray-300 w-full text-center">
                    ğŸ“ é–‹å•Ÿåœ–åº«
                    <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFileSelect(this)">
                </label>
                <div id="loading" class="loader"></div>
            </div>
            <img id="preview-img" class="w-full h-auto max-h-60 object-contain bg-gray-50 border border-gray-200 rounded mb-3 hidden">
            <input type="hidden" id="base64-store">

            <label class="block text-sm font-medium text-gray-700">æç¤ºè© (Prompts)</label>
            <textarea id="input-prompt" rows="5" placeholder="è¼¸å…¥æç¤ºè©..." class="mt-1 block w-full border border-gray-300 rounded-md p-2 mb-4"></textarea>

            <div class="flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700">å–æ¶ˆ</button>
                <button onclick="saveData()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">âœ… è¨Šæ¯</div>

    <script>
        // --- IndexedDB æ ¸å¿ƒè¨­å®š (é€™æ˜¯è®“å®¹é‡è®Šå¤§çš„é—œéµ) ---
        const DB_NAME = 'AIPromptDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'prompts';
        let db;

        // 1. åˆå§‹åŒ–è³‡æ–™åº«
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    }
                };
                request.onsuccess = (e) => {
                    db = e.target.result;
                    render(); // è³‡æ–™åº«é–‹å¥½å¾Œï¼Œç«‹åˆ»è®€å–ç•«é¢
                    resolve(db);
                };
                request.onerror = (e) => reject('DB Error');
            });
        }

        // 2. è®€å–æ‰€æœ‰è³‡æ–™
        async function getAllData() {
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => resolve([]);
            });
        }

        // 3. æ–°å¢è³‡æ–™
        async function addData(item) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.add(item);
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e);
            });
        }

        // 4. åˆªé™¤è³‡æ–™
        async function deleteData(id) {
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                store.delete(id);
                transaction.oncomplete = () => resolve();
            });
        }
        
        // 5. æ¸…ç©ºè³‡æ–™åº« (é‚„åŸç”¨)
        async function clearDB() {
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                store.clear();
                transaction.oncomplete = () => resolve();
            });
        }

        // --- ç•«é¢é‚è¼¯ ---

        async function render() {
            const app = document.getElementById('app');
            const emptyState = document.getElementById('empty-state');
            const loadingState = document.getElementById('loading-state');
            
            loadingState.classList.add('hidden');
            app.innerHTML = '';
            
            const prompts = await getAllData();

            if (prompts.length === 0) {
                app.appendChild(emptyState);
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            // å€’åºé¡¯ç¤º (æ–°çš„åœ¨ä¸Šé¢)
            prompts.reverse().forEach((item) => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden mb-4';
                
                let imgHtml = item.img ? `<img src="${item.img}" class="card-img">` : '';

                card.innerHTML = `
                    ${imgHtml}
                    <div class="p-4">
                        <div class="text-gray-800 text-sm mb-3 bg-gray-50 p-2 rounded border border-gray-100 font-mono break-all whitespace-pre-wrap">${item.text}</div>
                        <div class="flex justify-between items-center mt-2">
                            <button onclick="handleDelete(${item.id})" class="text-red-400 text-sm hover:text-red-600">åˆªé™¤</button>
                            <button onclick="copyText(this)" data-text="${item.text.replace(/"/g, '&quot;')}" class="bg-gray-800 text-white px-4 py-2 rounded-md text-sm font-bold active:scale-95 transition-transform">ğŸ“‹ è¤‡è£½</button>
                        </div>
                    </div>
                `;
                app.appendChild(card);
            });
        }

        // è™•ç†åœ–ç‰‡ (ä¾ç„¶å£“ç¸®ï¼Œä½†å…è¨±è¼ƒé«˜ç•«è³ª)
        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;
            document.getElementById('loading').style.display = 'inline-block';
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // æ”¾å¯¬é™åˆ¶åˆ° 1024pxï¼Œç•«è³ªæ›´å¥½
                    const MAX_WIDTH = 1024; 
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // å“è³ªæå‡åˆ° 0.85
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
                    
                    document.getElementById('preview-img').src = dataUrl;
                    document.getElementById('preview-img').classList.remove('hidden');
                    document.getElementById('base64-store').value = dataUrl;
                    document.getElementById('loading').style.display = 'none';
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function saveData() {
            const img = document.getElementById('base64-store').value;
            const text = document.getElementById('input-prompt').value;

            if (!text) { showToast('âŒ è«‹è¼¸å…¥æç¤ºè©'); return; }

            try {
                await addData({ img, text, date: new Date() });
                closeModal();
                render();
                // Reset
                document.getElementById('base64-store').value = '';
                document.getElementById('input-prompt').value = '';
                document.getElementById('preview-img').classList.add('hidden');
                document.getElementById('file-input').value = ''; 
                showToast('âœ… å„²å­˜æˆåŠŸ');
            } catch (e) {
                alert('å„²å­˜å¤±æ•—ï¼Œè«‹å›å ±éŒ¯èª¤');
                console.error(e);
            }
        }

        async function handleDelete(id) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) {
                await deleteData(id);
                render();
            }
        }

        function copyText(btn) {
            const text = btn.getAttribute('data-text');
            navigator.clipboard.writeText(text).then(() => showToast('âœ… å·²è¤‡è£½ï¼'));
        }

        // --- å‚™ä»½èˆ‡é‚„åŸ (é‡å°å¤§é‡è³‡æ–™å„ªåŒ–) ---
        async function exportData() {
            const data = await getAllData();
            if (data.length === 0) { showToast('æ²’æœ‰è³‡æ–™å¯å‚™ä»½'); return; }
            const dataStr = JSON.stringify(data);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `PromptBackup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        if(confirm('åŒ¯å…¥å°‡æœƒã€Œæ¸…ç©ºä¸¦è¦†è“‹ã€ç¾æœ‰è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ')) {
                            await clearDB();
                            // é€ç­†å¯«å…¥
                            for (let item of data) {
                                delete item.id; // é‡ç½® ID é¿å…è¡çª
                                await addData(item);
                            }
                            render();
                            showToast('âœ… é‚„åŸæˆåŠŸï¼');
                        }
                    } else { alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤'); }
                } catch (err) { alert('ç„¡æ³•è®€å–æª”æ¡ˆ'); }
            };
            reader.readAsText(file);
            input.value = ''; 
        }

        function openModal() { document.getElementById('modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // å•Ÿå‹•è³‡æ–™åº«
        initDB();
    </script>
</body>
</html>
