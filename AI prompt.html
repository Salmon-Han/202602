<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI æç¤ºè©åº« (å¡ç‰‡ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f0f2f5; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; }
        /* å¡ç‰‡åœ–ç‰‡è¨­å®šï¼šæ­£æ–¹å½¢è£åˆ‡ï¼Œæ•´é½Šå¥½çœ‹ */
        .card-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #e5e7eb; }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 14px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 200; white-space: nowrap; }
        .toast.show { opacity: 1; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #6366f1; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; display: none;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* æ–‡å­—æˆªæ–· */
        .line-clamp-1 { display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
    </style>
</head>
<body>

    <div class="bg-indigo-600 text-white px-4 py-3 shadow-md sticky top-0 z-20 flex justify-between items-center">
        <h1 class="text-lg font-bold tracking-wide">ğŸ¨ AI è©åº«</h1>
        <div class="flex space-x-2">
            <button onclick="exportData()" class="bg-indigo-500 active:bg-indigo-700 p-2 rounded text-xs border border-indigo-400">â¬‡ å‚™ä»½</button>
            <button onclick="document.getElementById('import-file').click()" class="bg-indigo-500 active:bg-indigo-700 p-2 rounded text-xs border border-indigo-400">â¬† é‚„åŸ</button>
            <input type="file" id="import-file" style="display: none;" onchange="importData(this)">
        </div>
    </div>

    <div class="p-3">
        <div id="loading-state" class="text-center text-gray-500 mt-10 text-sm">è³‡æ–™è®€å–ä¸­...</div>
        
        <div id="app" class="grid grid-cols-2 gap-3">
            </div>

        <div id="empty-state" class="text-center text-gray-400 mt-20 hidden col-span-2">
            <p class="text-lg">ğŸ“­</p>
            <p class="text-sm mt-2">é‚„æ²’æœ‰æ”¶è—ï¼Œé»æ“Šå³ä¸‹è§’æ–°å¢</p>
        </div>
    </div>

    <div class="fixed bottom-6 right-6 z-30">
        <button onclick="openModal()" class="bg-indigo-600 active:bg-indigo-800 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-xl text-3xl font-bold transition-transform active:scale-90 shadow-indigo-500/50">+</button>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl w-full max-w-md shadow-2xl flex flex-col max-h-[90vh]">
            
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                <h2 id="modal-title" class="text-lg font-bold text-gray-800">æ–°å¢æç¤ºè©</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
            </div>

            <div class="p-4 overflow-y-auto flex-1">
                <input type="hidden" id="edit-id"> <label class="block text-xs font-bold text-gray-500 uppercase mb-1">é è¦½åœ–ç‰‡</label>
                <div class="mb-4 text-center">
                    <img id="preview-img" class="w-full h-auto max-h-60 object-contain bg-gray-100 rounded border border-gray-200 hidden mx-auto">
                    
                    <div class="flex items-center justify-center mt-2 space-x-2">
                        <label class="cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm px-4 py-2 rounded-lg border border-gray-300 transition-colors w-full text-center">
                            ğŸ“· <span id="upload-text">é¸æ“‡åœ–ç‰‡</span>
                            <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFileSelect(this)">
                        </label>
                        <div id="loading" class="loader"></div>
                    </div>
                    <input type="hidden" id="base64-store">
                </div>

                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">æ¨™é¡Œ (åç¨±)</label>
                <input type="text" id="input-title" placeholder="ä¾‹å¦‚ï¼šè³½åšé¾å…‹è²“..." class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none mb-4 font-bold">

                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">æç¤ºè© (Prompts)</label>
                <textarea id="input-prompt" rows="5" placeholder="è¼¸å…¥å’’èª..." class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none font-mono leading-relaxed"></textarea>
            </div>

            <div class="p-4 border-t flex justify-between items-center bg-gray-50 rounded-b-xl">
                <button id="btn-delete" onclick="handleDelete()" class="text-red-500 text-sm font-medium px-2 py-2 hidden">åˆªé™¤æ­¤å¡ç‰‡</button>
                <div class="flex space-x-3 ml-auto">
                    <button onclick="closeModal()" class="px-4 py-2 text-gray-500 text-sm font-medium hover:bg-gray-200 rounded-lg transition-colors">å–æ¶ˆ</button>
                    <button onclick="saveData()" class="px-6 py-2 bg-indigo-600 text-white text-sm font-bold rounded-lg shadow-lg shadow-indigo-500/30 hover:bg-indigo-700 active:scale-95 transition-all">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">âœ… è¨Šæ¯</div>

    <script>
        // --- IndexedDB è¨­å®š (è³‡æ–™åº«é‚è¼¯) ---
        const DB_NAME = 'AIPromptDB';
        const DB_VERSION = 1; // ä¿æŒç‰ˆæœ¬è™Ÿï¼Œè³‡æ–™çµæ§‹æ˜¯é€šç”¨çš„
        const STORE_NAME = 'prompts';
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    }
                };
                request.onsuccess = (e) => {
                    db = e.target.result;
                    render();
                    resolve(db);
                };
                request.onerror = (e) => reject('DB Error');
            });
        }

        async function getAllData() {
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => resolve([]);
            });
        }

        async function putData(item) {
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                store.put(item); // put åŒæ™‚æ”¯æ´æ–°å¢èˆ‡ä¿®æ”¹ (åªè¦æœ‰ id å°±æ˜¯ä¿®æ”¹)
                transaction.oncomplete = () => resolve();
            });
        }

        async function deleteData(id) {
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                store.delete(id);
                transaction.oncomplete = () => resolve();
            });
        }
        
        async function clearDB() {
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                store.clear();
                transaction.oncomplete = () => resolve();
            });
        }

        // --- ä»‹é¢æ¸²æŸ“é‚è¼¯ ---

        let currentData = []; // å¿«å–è³‡æ–™

        async function render() {
            const app = document.getElementById('app');
            const emptyState = document.getElementById('empty-state');
            document.getElementById('loading-state').classList.add('hidden');
            
            app.innerHTML = '';
            
            currentData = await getAllData();

            if (currentData.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            // å€’åºé¡¯ç¤º (æ–°çš„åœ¨æœ€å‰é¢)
            [...currentData].reverse().forEach((item) => {
                const card = document.createElement('div');
                // å¡ç‰‡æ¨£å¼
                card.className = 'bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col relative active:scale-[0.98] transition-transform duration-100';
                
                // è™•ç†æ¨™é¡Œ (èˆŠè³‡æ–™æ²’æœ‰æ¨™é¡Œçš„è™•ç†æ–¹å¼)
                const displayTitle = item.title ? item.title : 'æœªå‘½åä½œå“';
                
                // åœ–ç‰‡é¡¯ç¤º (é»æ“Šåœ–ç‰‡æ‰“é–‹ç·¨è¼¯)
                let imgHtml = item.img 
                    ? `<img src="${item.img}" class="card-img cursor-pointer" onclick="openModal(${item.id})">` 
                    : `<div class="card-img bg-gray-200 flex items-center justify-center text-gray-400 cursor-pointer" onclick="openModal(${item.id})">ç„¡åœ–ç‰‡</div>`;

                card.innerHTML = `
                    ${imgHtml}
                    
                    <div class="p-2 flex flex-col flex-1">
                        <div class="text-xs font-bold text-gray-800 mb-2 line-clamp-1 cursor-pointer" onclick="openModal(${item.id})">${displayTitle}</div>
                        
                        <button onclick="copyText(event, this)" data-text="${item.text.replace(/"/g, '&quot;')}" class="mt-auto w-full bg-gray-50 hover:bg-gray-100 text-gray-600 border border-gray-200 rounded-lg py-1.5 text-xs font-bold flex items-center justify-center space-x-1 transition-colors">
                            <span>ğŸ“‹</span> <span>è¤‡è£½</span>
                        </button>
                    </div>
                `;
                app.appendChild(card);
            });
        }

        // --- äº’å‹•åŠŸèƒ½ ---

        // é–‹å•Ÿè¦–çª— (æ–°å¢ æˆ– ç·¨è¼¯)
        function openModal(id = null) {
            const modal = document.getElementById('modal');
            const titleEl = document.getElementById('modal-title');
            const uploadText = document.getElementById('upload-text');
            const btnDelete = document.getElementById('btn-delete');
            
            // é‡ç½®è¡¨å–®
            document.getElementById('edit-id').value = '';
            document.getElementById('input-title').value = '';
            document.getElementById('input-prompt').value = '';
            document.getElementById('base64-store').value = '';
            document.getElementById('preview-img').src = '';
            document.getElementById('preview-img').classList.add('hidden');

            if (id) {
                // --- ç·¨è¼¯æ¨¡å¼ ---
                const item = currentData.find(d => d.id === id);
                if (item) {
                    document.getElementById('edit-id').value = item.id; // å­˜å…¥ ID
                    document.getElementById('input-title').value = item.title || '';
                    document.getElementById('input-prompt').value = item.text;
                    
                    if (item.img) {
                        document.getElementById('base64-store').value = item.img;
                        document.getElementById('preview-img').src = item.img;
                        document.getElementById('preview-img').classList.remove('hidden');
                    }
                    
                    titleEl.innerText = 'ç·¨è¼¯å¡ç‰‡';
                    uploadText.innerText = 'æ›´æ›åœ–ç‰‡';
                    btnDelete.classList.remove('hidden'); // é¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
                }
            } else {
                // --- æ–°å¢æ¨¡å¼ ---
                titleEl.innerText = 'æ–°å¢å¡ç‰‡';
                uploadText.innerText = 'é¸æ“‡åœ–ç‰‡';
                btnDelete.classList.add('hidden'); // éš±è—åˆªé™¤æŒ‰éˆ•
            }

            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        // åœ–ç‰‡å£“ç¸®è™•ç†
        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;
            document.getElementById('loading').style.display = 'inline-block';
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ä¿æŒè¼ƒå¥½çš„ç•«è³ª
                    const MAX_WIDTH = 1024; 
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
                    
                    document.getElementById('preview-img').src = dataUrl;
                    document.getElementById('preview-img').classList.remove('hidden');
                    document.getElementById('base64-store').value = dataUrl;
                    document.getElementById('loading').style.display = 'none';
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // å„²å­˜è³‡æ–™ (åˆ¤æ–·æ˜¯æ–°å¢é‚„æ˜¯æ›´æ–°)
        async function saveData() {
            const idStr = document.getElementById('edit-id').value;
            const title = document.getElementById('input-title').value.trim();
            const img = document.getElementById('base64-store').value;
            const text = document.getElementById('input-prompt').value;

            if (!text && !img) { showToast('âŒ è«‹è‡³å°‘è¼¸å…¥å…§å®¹æˆ–åœ–ç‰‡'); return; }

            const item = {
                title: title,
                img: img,
                text: text,
                date: new Date()
            };

            // å¦‚æœæœ‰ ID ä»£è¡¨æ˜¯ä¿®æ”¹ï¼Œè¦è£œä¸Š ID
            if (idStr) {
                item.id = parseInt(idStr);
            }

            try {
                await putData(item); // IndexedDB æœƒè‡ªå‹•è™•ç†æ–°å¢æˆ–æ›´æ–°
                closeModal();
                render();
                showToast(idStr ? 'âœ… ä¿®æ”¹æˆåŠŸ' : 'âœ… æ–°å¢æˆåŠŸ');
            } catch (e) {
                alert('å„²å­˜å¤±æ•—');
            }
        }

        // åˆªé™¤ç›®å‰ç·¨è¼¯çš„é€™ç­†
        async function handleDelete() {
            const idStr = document.getElementById('edit-id').value;
            if (!idStr) return;
            
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µå¡ç‰‡å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) {
                await deleteData(parseInt(idStr));
                closeModal();
                render();
                showToast('ğŸ—‘ï¸ å·²åˆªé™¤');
            }
        }

        // è¤‡è£½æ–‡å­— (æ³¨æ„ event.stopPropagation é˜²æ­¢é»æ“ŠæŒ‰éˆ•æ™‚è§¸ç™¼é–‹çª—)
        function copyText(e, btn) {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ (ä¸æœƒæ‰“é–‹ç·¨è¼¯è¦–çª—)
            const text = btn.getAttribute('data-text');
            navigator.clipboard.writeText(text).then(() => showToast('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼'));
        }

        // --- å‚™ä»½é‚„åŸ ---
        async function exportData() {
            const data = await getAllData();
            if (data.length === 0) { showToast('æ²’æœ‰è³‡æ–™å¯å‚™ä»½'); return; }
            const dataStr = JSON.stringify(data);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CardsBackup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        if(confirm('è­¦å‘Šï¼šåŒ¯å…¥å°‡æœƒã€Œæ¸…ç©ºç›®å‰æ‰€æœ‰è³‡æ–™ã€ä¸¦è¦†è“‹ã€‚ç¢ºå®šå—ï¼Ÿ')) {
                            await clearDB();
                            for (let item of data) {
                                // ç§»é™¤èˆŠ ID è®“è³‡æ–™åº«é‡é…ï¼Œæˆ–è€…ä¿ç•™ ID (é€™è£¡é¸æ“‡ç§»é™¤ä»¥é¿å…è¡çª)
                                // å¦‚æœä½ æ˜¯è¦å®Œç¾é·ç§»ï¼Œä¿ç•™ title æ¬„ä½
                                delete item.id; 
                                await putData(item);
                            }
                            render();
                            showToast('âœ… é‚„åŸæˆåŠŸï¼');
                        }
                    } else { alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤'); }
                } catch (err) { alert('ç„¡æ³•è®€å–æª”æ¡ˆ'); }
            };
            reader.readAsText(file);
            input.value = ''; 
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        initDB();
    </script>
</body>
</html>
