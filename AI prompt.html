<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æç¤ºè©åº« (åœ–åº«ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6; padding-bottom: 100px; }
        .card-img { width: 100%; height: 200px; object-fit: cover; border-radius: 8px 8px 0 0; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 100; }
        .toast.show { opacity: 1; }
        /* è®€å–ä¸­çš„è½‰åœˆåœˆ */
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3498db; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-left: 10px; display: none;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-10 flex justify-between items-center">
        <h1 class="text-lg font-bold">ğŸ¨ AI æç¤ºè©åº«</h1>
        <div class="space-x-1">
            <button onclick="exportData()" class="bg-blue-500 hover:bg-blue-400 text-white text-xs px-3 py-2 rounded border border-blue-400">â¬‡ å‚™ä»½</button>
            <button onclick="document.getElementById('import-file').click()" class="bg-blue-500 hover:bg-blue-400 text-white text-xs px-3 py-2 rounded border border-blue-400">â¬† é‚„åŸ</button>
            <input type="file" id="import-file" style="display: none;" onchange="importData(this)">
        </div>
    </div>

    <div id="app" class="p-4 max-w-md mx-auto space-y-4">
        <div id="empty-state" class="text-center text-gray-400 mt-10 hidden">
            <p>ç›®å‰æ²’æœ‰è³‡æ–™</p>
            <p class="text-sm mt-2">é»æ“Šå³ä¸‹è§’ + å¾åœ–åº«æ–°å¢</p>
        </div>
    </div>

    <div class="fixed bottom-6 right-6">
        <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg text-3xl font-bold">+</button>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg w-full max-w-md p-6 shadow-xl">
            <h2 class="text-xl font-bold mb-4">æ–°å¢æç¤ºè©</h2>
            
            <label class="block text-sm font-medium text-gray-700 mb-1">é¸æ“‡åœ–ç‰‡ (è‡ªå‹•å£“ç¸®)</label>
            <div class="flex items-center space-x-2 mb-4">
                <label class="cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-md border border-gray-300 w-full text-center">
                    ğŸ“ é»æ­¤é–‹å•Ÿåœ–åº«
                    <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFileSelect(this)">
                </label>
                <div id="loading" class="loader"></div>
            </div>
            <img id="preview-img" class="w-full h-32 object-contain bg-gray-50 border border-gray-200 rounded mb-3 hidden">
            <input type="hidden" id="base64-store">

            <label class="block text-sm font-medium text-gray-700">æç¤ºè© (Prompts)</label>
            <textarea id="input-prompt" rows="4" placeholder="è¼¸å…¥è‹±æ–‡æç¤ºè©..." class="mt-1 block w-full border border-gray-300 rounded-md p-2 mb-4"></textarea>

            <div class="flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700">å–æ¶ˆ</button>
                <button onclick="saveData()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">âœ… è¨Šæ¯</div>

    <script>
        let prompts = JSON.parse(localStorage.getItem('ai_prompts')) || [];
        
        function render() {
            const app = document.getElementById('app');
            const emptyState = document.getElementById('empty-state');
            app.innerHTML = '';
            
            if (prompts.length === 0) {
                app.appendChild(emptyState);
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            prompts.slice().reverse().forEach((item, index) => {
                const originalIndex = prompts.length - 1 - index;
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden';
                
                // åˆ¤æ–·åœ–ç‰‡é¡¯ç¤º
                let imgHtml = `<div class="h-20 bg-gray-200 flex items-center justify-center text-gray-400">ç„¡åœ–ç‰‡</div>`;
                if (item.img) {
                    imgHtml = `<img src="${item.img}" class="card-img">`;
                }

                card.innerHTML = `
                    ${imgHtml}
                    <div class="p-4">
                        <div class="text-gray-800 text-sm mb-3 bg-gray-50 p-2 rounded border border-gray-100 font-mono break-all">${item.text}</div>
                        <div class="flex justify-between items-center mt-2">
                            <button onclick="deleteItem(${originalIndex})" class="text-red-400 text-sm hover:text-red-600">åˆªé™¤</button>
                            <button onclick="copyText(this)" data-text="${item.text.replace(/"/g, '&quot;')}" class="bg-gray-800 text-white px-4 py-2 rounded-md text-sm font-bold active:scale-95 transition-transform">ğŸ“‹ è¤‡è£½</button>
                        </div>
                    </div>
                `;
                app.appendChild(card);
            });
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šåœ–ç‰‡è™•ç†èˆ‡å£“ç¸® ---
        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            document.getElementById('loading').style.display = 'inline-block';

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    // å»ºç«‹ Canvas é€²è¡Œå£“ç¸®
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // è¨­å®šæœ€å¤§å¯¬åº¦ (å£“ç¸®é—œéµ)
                    const MAX_WIDTH = 500; 
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // è½‰æˆ JPEG æ ¼å¼ï¼Œå“è³ª 0.7
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // é¡¯ç¤ºé è¦½ä¸¦å­˜åˆ°éš±è—æ¬„ä½
                    document.getElementById('preview-img').src = dataUrl;
                    document.getElementById('preview-img').classList.remove('hidden');
                    document.getElementById('base64-store').value = dataUrl;
                    
                    document.getElementById('loading').style.display = 'none';
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function saveData() {
            const img = document.getElementById('base64-store').value;
            const text = document.getElementById('input-prompt').value;

            if (!text) { showToast('âŒ è«‹è¼¸å…¥æç¤ºè©'); return; }

            // æª¢æŸ¥å„²å­˜ç©ºé–“
            try {
                prompts.push({ img, text });
                localStorage.setItem('ai_prompts', JSON.stringify(prompts));
                closeModal();
                render();
                // é‡ç½®è¡¨å–®
                document.getElementById('base64-store').value = '';
                document.getElementById('input-prompt').value = '';
                document.getElementById('preview-img').classList.add('hidden');
                document.getElementById('file-input').value = ''; 
                showToast('âœ… å„²å­˜æˆåŠŸ');
            } catch (e) {
                showToast('âš ï¸ å„²å­˜å¤±æ•—ï¼å®¹é‡å·²æ»¿');
                alert('å„²å­˜ç©ºé–“å·²æ»¿ï¼å› ç‚ºé€™æ˜¯åœ¨ç€è¦½å™¨å„²å­˜ï¼Œå®¹é‡æœ‰é™ã€‚è«‹å…ˆåˆªé™¤ä¸€äº›èˆŠåœ–ç‰‡ï¼Œæˆ–æ˜¯ä½¿ç”¨ã€Œå‚™ä»½ã€åŠŸèƒ½å°‡èˆŠè³‡æ–™å­˜åˆ°é›»è…¦å¾Œï¼Œæ¸…é™¤é€™è£¡çš„è³‡æ–™ã€‚');
                // å›æ»¾
                prompts.pop();
            }
        }

        function deleteItem(index) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) {
                prompts.splice(index, 1);
                localStorage.setItem('ai_prompts', JSON.stringify(prompts));
                render();
            }
        }

        function copyText(btn) {
            const text = btn.getAttribute('data-text');
            navigator.clipboard.writeText(text).then(() => showToast('âœ… å·²è¤‡è£½ï¼'));
        }

        // å‚™ä»½åŠŸèƒ½
        function exportData() {
            if (prompts.length === 0) { showToast('æ²’æœ‰è³‡æ–™å¯å‚™ä»½'); return; }
            const dataStr = JSON.stringify(prompts);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai_prompts_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast('â¬‡ å‚™ä»½æª”æ¡ˆä¸‹è¼‰ä¸­');
        }

        // é‚„åŸåŠŸèƒ½
        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        if(confirm('åŒ¯å…¥å°‡æœƒã€Œè¦†è“‹ã€ç¾æœ‰è³‡æ–™ï¼Œå»ºè­°å…ˆå‚™ä»½ç›®å‰è³‡æ–™ã€‚ç¢ºå®šè¦åŒ¯å…¥å—ï¼Ÿ')) {
                            prompts = data;
                            localStorage.setItem('ai_prompts', JSON.stringify(prompts));
                            render();
                            showToast('âœ… é‚„åŸæˆåŠŸï¼');
                        }
                    } else { alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤'); }
                } catch (err) { alert('ç„¡æ³•è®€å–æª”æ¡ˆ'); }
            };
            reader.readAsText(file);
            input.value = ''; 
        }

        function openModal() { document.getElementById('modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        render();
    </script>
</body>
</html>
