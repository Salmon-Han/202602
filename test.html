
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 關東自駕遊 App</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel (讓瀏覽器看不懂的 JSX 變成懂的 JS) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-black': '#121212',
                        'jp-dark': '#1e1e1e',
                        'jp-gray': '#2c2c2c',
                        'jp-light': '#e5e5e5',
                        'jp-red': '#b91c1c', 
                        'jp-gold': '#c5a059',
                        'jp-indigo': '#312e81',
                        'jp-accent': '#d4af37',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s ease-out',
                        'fade-in': 'fadeIn 0.3s ease-out',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #121212; color: #e5e5e5; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glass-panel { background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .card-bg-gradient { background: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 100%); }
        .pt-env-top { padding-top: env(safe-area-inset-top, 20px); }
        .pb-env-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-left-color: #c5a059; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "firebase/": "https://aistudiocdn.com/firebase@^12.6.0/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDK (模組化載入並掛載到 window) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBjTfFaJfN6Vbv3_PjykOS5IjEwewtKNk4",
            authDomain: "japantripapp-ff22f.firebaseapp.com",
            projectId: "japantripapp-ff22f",
            storageBucket: "japantripapp-ff22f.firebasestorage.app",
            messagingSenderId: "865746692066",
            appId: "1:865746692066:web:f853fde276f0940785fbbb"
        };

        try {
            const app = initializeApp(firebaseConfig);
            // 將 Firebase 功能掛載到 window 物件，讓 React (Babel) 腳本可以讀取
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            window.firebaseModules = { signInAnonymously, collection, doc, setDoc, deleteDoc, onSnapshot };
            console.log("Firebase initialized");
        } catch (e) {
            console.error("Firebase init error:", e);
        }
    </script>

    <!-- React Application Logic -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Constants (Data) ---
        const INITIAL_ITINERARY = [
            {
                id: 'day1', dayLabel: 'Day 1', date: '2/8 (日)', title: '啟程東京', location: '台北 -> 成田', 
                coords: { lat: 35.7719, lon: 140.3929 }, // Narita
                events: [
                    { id: 'd1-1', type: 'transport', time: '12:50', title: '捷星航空 GK14', desc: '台北(TPE) T1 -> 東京(NRT) T3。', nav: 'Narita International Airport Terminal 3', highlight: '行李：手提7kg / 託運30kg+20kg', travelInfo: '機場接駁 | 30分' },
                    { 
                        id: 'd1-2', type: 'stay', time: '18:00', title: '東橫INN 成田機場 本館', 
                        desc: '作為日本最大規模的東橫INN，本館擁有數千間客房，是許多紅眼班機或自駕旅客的首選中繼站。對於租車旅客而言，這裡擁有超大型的平面與立體停車場，停車極為便利。', 
                        nav: 'Toyoko Inn Narita Airport Honkan', highlight: '已預訂 (早餐/停車付費)', subInfo: '¥11,495 (現場付)' 
                    }
                ]
            },
            {
                id: 'day2', dayLabel: 'Day 2', date: '2/9 (一)', title: '茨城名瀑與鮟鱇魚', location: '成田 -> 水戶',
                coords: { lat: 36.3659, lon: 140.4712 }, // Mito
                events: [
                    { id: 'd2-0', type: 'stay', time: '08:30', title: '出發：東橫INN 成田機場', desc: '辦理退房，前往租車。', nav: 'Toyoko Inn Narita Airport Honkan', highlight: '記得帶走所有行李', travelInfo: '接駁車 | 15分' },
                    { id: 'd2-1', type: 'transport', time: '09:00', title: '租車取車', desc: 'Toyota Rent a Car 成田機場店。Sienta HEV。', nav: 'Toyota Rent a Car Narita Airport', highlight: '預約番號：99758887600', subInfo: '費用：¥108,900', travelInfo: '85km | 2小時' },
                    { 
                        id: 'd2-2', type: 'sight', time: '10:30', title: '袋田瀑布', 
                        desc: '名列「日本三大名瀑」之一，高 120 公尺、寬 73 公尺，水流分四段落下。冬季（1月至2月）是這裡最神祕的季節，極寒時瀑布會結凍形成壯觀的「冰瀑」奇景。', 
                        nav: 'Fukuroda Falls', highlight: '建議停留1小時', travelInfo: '45km | 1小時' 
                    },
                    { 
                        id: 'd2-3', type: 'food', time: '12:45', title: '午餐：鮟鱇魚鍋', 
                        desc: '茨城縣冬季最具代表性的極品美食。道地的鮟鱇魚鍋通常以味噌為基底，將魚肝融入湯頭中，煮出濃郁橘黃色的精華高湯。', 
                        nav: 'Sansui Mito', highlight: '必吃：鮟鱇魚肝味噌湯底', travelInfo: '市區 | 15分' 
                    },
                    { 
                        id: 'd2-4', type: 'sight', time: '14:30', title: '偕樂園 賞梅', 
                        desc: '與金澤兼六園、岡山後樂園並列為「日本三大名園」。這裡最著名的就是梅花，園內種植了約 100 品種、3000 棵梅樹。', 
                        nav: 'Kairakuen', highlight: '可參觀好文亭', travelInfo: '市區 | 10分' 
                    },
                    { 
                        id: 'd2-5', type: 'stay', time: '17:00', title: 'Dormy Inn 水戶', 
                        desc: '位於水戶市中心的連鎖商務飯店，Dormy Inn 系列最大的特色就是擁有天然溫泉大浴場。', 
                        nav: 'Dormy Inn Mito', highlight: '設施：大浴場/桑拿', travelInfo: '步行/短程' 
                    },
                    { 
                        id: 'd2-6', type: 'food', time: '18:30', title: '晚餐：常陸牛', 
                        desc: '茨城縣引以為傲的頂級黑毛和牛品牌。其特徵是如大理石般細緻分佈的霜降油花，肉質軟嫩，入口即化。', 
                        nav: 'Restaurant Iijima', highlight: '必吃：牛排/壽喜燒' 
                    }
                ]
            },
            {
                id: 'day3', dayLabel: 'Day 3', date: '2/10 (二)', title: '日光東照宮', location: '水戶 -> 日光',
                coords: { lat: 36.7199, lon: 139.6982 }, // Nikko
                events: [
                    { id: 'd3-0', type: 'stay', time: '08:30', title: '出發：Dormy Inn 水戶', desc: '辦理退房。', nav: 'Dormy Inn Mito', highlight: '早餐後出發', travelInfo: '50km | 50分' },
                    { 
                        id: 'd3-1', type: 'sight', time: '09:20', title: '常陸國出雲大社', 
                        desc: '位於笠間市，是島根縣出雲大社的分社，主祀大國主大神，以祈求結緣聞名。這裡最震撼的視覺焦點是拜殿上掛著的巨大「注連繩」，重達 6 噸。', 
                        nav: 'Hitachinokuni Izumo Taisha', highlight: '參拜時間約40-60分', travelInfo: '90km | 1.5小時' 
                    },
                    { id: 'd3-2', type: 'food', time: '12:20', title: '午餐：日光湯波料理', desc: '日光名物豆皮料理。推薦：和風餐廳 Yubazen。', nav: 'Yubazen Nikko', highlight: '豆皮料理', travelInfo: '短程 | 10分' },
                    { 
                        id: 'd3-3', type: 'sight', time: '13:30', title: '日光東照宮', 
                        desc: '世界文化遺產，供奉江戶幕府初代將軍德川家康的神社。這裡以極致奢華、金碧輝煌的「陽明門」聞名於世。', 
                        nav: 'Nikko Toshogu', highlight: '必看：三猿、眠貓、陽明門', travelInfo: '15km | 40分 (山路)' 
                    },
                    { 
                        id: 'd3-4', type: 'sight', time: '15:40', title: '華嚴瀑布 & 中禪寺湖', 
                        desc: '位於日光國立公園，是中禪寺湖的湖水流出所形成的壯麗瀑布，落差高達 97 公尺，名列「日本三大名瀑」之一。', 
                        nav: 'Kegon Falls', highlight: '電梯16:30關閉', travelInfo: '50km | 1小時' 
                    },
                    { 
                        id: 'd3-5', type: 'stay', time: '17:30', title: '東橫INN 宇都宮站前', 
                        desc: '地理位置極佳，就位於 JR 宇都宮車站西口步行範圍內，周邊百貨公司、餐廳林立。', 
                        nav: 'Toyoko Inn Utsunomiya-eki Mae 1', highlight: '', travelInfo: '步行' 
                    },
                    { 
                        id: 'd3-6', type: 'food', time: '18:30', title: '晚餐：宇都宮餃子', 
                        desc: '宇都宮市被稱為「餃子之都」，市內擁有超過 200 家餃子專賣店。', 
                        nav: 'Kirasse Honten', highlight: '餃子之都巡禮' 
                    }
                ]
            },
            {
                id: 'day4', dayLabel: 'Day 4', date: '2/11 (三)', title: '足利古城與雪國', location: '宇都宮 -> 南魚沼',
                coords: { lat: 37.0645, lon: 138.8785 },
                events: [
                    { id: 'd4-0', type: 'stay', time: '09:00', title: '出發：東橫INN 宇都宮', desc: '睡飽出發，經北關東道前往足利。', nav: 'Toyoko Inn Utsunomiya-eki Mae 1', highlight: '', travelInfo: '55km | 50分' },
                    { 
                        id: 'd4-1', type: 'sight', time: '10:00', title: '足利氏館 (鑁阿寺)', 
                        desc: '日本百名城之一，也是足利氏的發源地。本堂是日本國寶，雖為寺廟，但四周有土壘與護城河，充滿了古樸的戰國武家氛圍。', 
                        nav: 'Bannaji Temple', highlight: '國寶本堂/日本百名城', travelInfo: '50km | 50分' 
                    },
                    { 
                        id: 'd4-2', type: 'food', time: '12:30', title: '午餐：高崎名物', 
                        desc: '推薦嘗試群馬名物：\n1. 「登利平」鳥飯 (Torihei)：群馬縣民的靈魂便當，醬汁雞肉飯。\n2. 「高崎義大利麵」：以份量大、口味濃郁著稱。', 
                        nav: 'Torihei Honten', travelInfo: '10km | 20分' 
                    },
                    { 
                        id: 'd4-3', type: 'sight', time: '13:45', title: '少林山達摩寺', 
                        desc: '達摩不倒翁的發源地。本堂堆滿了成千上萬個達摩，景象非常壯觀。新年期間會有許多人來此購買達摩許願。', 
                        nav: 'Shorinzan Darumaji', highlight: '達摩發源地', travelInfo: '120km | 2小時 (關越道)' 
                    },
                    { 
                        id: 'd4-4', type: 'transport', time: '14:30', title: '前往南魚沼', 
                        desc: '經由關越自動車道，穿越長長的「關越隧道」後，世界會瞬間變成銀白色的豪雪地帶 (川端康成《雪國》舞台)。請注意雪地駕駛。', 
                        nav: 'Sakadojo', highlight: '穿越豪雪隧道', travelInfo: '抵達飯店' 
                    },
                    { 
                        id: 'd4-5', type: 'stay', time: '16:00', title: '坂戶城 溫泉旅館', 
                        desc: '位於六日町溫泉的戰國歷史主題旅館。既然取消了下午行程，建議準時入住，先去泡露天溫泉暖身，欣賞被雪覆蓋的庭園，享受悠閒時光。', 
                        nav: 'Sakadojo', highlight: '提早入住享受溫泉', travelInfo: '接駁/短程' 
                    },
                    { 
                        id: 'd4-6', type: 'food', time: '18:00', title: '晚餐：南魚沼越光米', 
                        desc: '晚餐推薦名單：\n1. 「欅亭 (Keyaki Tei)」：極品洋食與米飯。\n2. 「魚沼釜蔵」：鄉土料理與地酒。', 
                        nav: 'Keyaki Tei', highlight: '推薦：Keyaki Tei 洋食' 
                    }
                ]
            },
            {
                id: 'day5', dayLabel: 'Day 5', date: '2/12 (四)', title: '工藝與能量', location: '南魚沼 -> 新潟',
                coords: { lat: 37.6366, lon: 138.9616 },
                events: [
                    { id: 'd5-0', type: 'stay', time: '08:15', title: '出發：坂戶城', desc: '辦理退房，提早出發以免塞車。', nav: 'Sakadojo', highlight: '雪地駕車小心', travelInfo: '60km | 50分' },
                    { 
                        id: 'd5-1', type: 'sight', time: '09:45', title: '三条鍛冶道場', 
                        desc: '新潟縣三条市是世界聞名的金屬加工與鍛造重鎮。這個道場是為了傳承鍛造技術而設，開放給一般遊客體驗。', 
                        nav: 'Sanjo Blacksmith Dojo', highlight: '上午場只到11:00', travelInfo: '20km | 30分' 
                    },
                    { 
                        id: 'd5-2', type: 'sight', time: '11:00', title: '彌彥神社', 
                        desc: '越後地區的一之宮，是新潟縣地位最高、香火最鼎盛的神社。神社座落在神聖的彌彥山腳下，被古老的杉木林環繞。', 
                        nav: 'Yahiko Shrine', highlight: '午餐：釜飯彌醉亭 或 熊貓燒', travelInfo: '40km | 50分' 
                    },
                    { 
                        id: 'd5-3', type: 'sight', time: '15:30', title: 'Pier Bandai', 
                        desc: '位於新潟市區、信濃川河口附近的超大型複合式市場，被譽為新潟的「食之主題樂園」。這裡集合了市場、迴轉壽司、鮮魚中心、肉舖與酒鋪。', 
                        nav: 'Pier Bandai', highlight: '推薦：弁慶壽司、爆彈飯糰', travelInfo: '市區 | 10分' 
                    },
                    { 
                        id: 'd5-4', type: 'stay', time: '17:00', title: '東橫INN 新潟站前', 
                        desc: '位於新潟交通樞紐的絕佳位置，距離新潟車站萬代口步行僅需幾分鐘。周邊是新潟最熱鬧的繁華街。', 
                        nav: 'Toyoko Inn Niigata Ekimae', highlight: '', travelInfo: '步行' 
                    },
                    { 
                        id: 'd5-5', type: 'food', time: '18:00', title: '晚餐：新潟站前', 
                        desc: '新潟車站前居酒屋激戰區。推薦嘗試新潟名物「醬汁豬排丼」(Tare-Katsu)。', 
                        nav: 'Niigata Station', highlight: '推薦：炸豬排太郎(醬汁豬排)、須坂屋(布海苔蕎麥麵)' 
                    }
                ]
            },
            {
                id: 'day6', dayLabel: 'Day 6', date: '2/13 (五)', title: '野猿公苑與壽司', location: '新潟 -> 長野',
                coords: { lat: 36.7329, lon: 138.4621 },
                events: [
                    { id: 'd6-0', type: 'stay', time: '09:00', title: '出發：東橫INN 新潟站前', desc: '辦理退房，出發前往妙高/長野方向。', nav: 'Toyoko Inn Niigata Ekimae', highlight: '確認車況與雪胎', travelInfo: '110km | 1小時45分' },
                    { 
                        id: 'd6-1', type: 'transport', time: '10:45', title: '道之驛 Arai (午餐)', 
                        desc: '位於上信越自動車道旁，是一個與高速公路休息站連通的「Highway Oasis」。這裡不僅是休息站，更像是一個美食聚落。', 
                        nav: 'Roadside Station Arai', highlight: '必吃：白蝦/鰤魚/螃蟹', travelInfo: '休息站內' 
                    },
                    { id: 'd6-2', type: 'food', time: '12:00', title: 'Kito Kito 壽司', desc: '享用美味壽司午餐。平板點餐，出餐快速。', nav: 'Kito Kito Sushi Arai', highlight: '平板點餐', travelInfo: '45km | 45分' },
                    { id: 'd6-3', type: 'transport', time: '12:45', title: '前往野猿公苑', desc: '信州中野IC下，往志賀高原。', nav: 'Jigokudani Monkey Park Parking', highlight: 'MapCode: 341 740 584*55', travelInfo: '步行 1.6km (30分)' },
                    { 
                        id: 'd6-4', type: 'sight', time: '13:40', title: '地獄谷野猿公苑', 
                        desc: '全球唯一可以看到野生猴子（日本獼猴）泡溫泉的地方，是長野縣冬季最國際化的景點。', 
                        nav: 'Jigokudani Monkey Park', highlight: '裝備：手套/毛帽/防滑鞋', travelInfo: '步行回程+駕車 (35km | 50分)' 
                    },
                    { id: 'd6-5', type: 'transport', time: '15:30', title: '前往長野市區', desc: '天黑前下山，前往飯店。', nav: 'Toyoko Inn Nagano-eki Higashi-guchi', highlight: '小心傍晚路況', travelInfo: '市區 | 10分' },
                    { 
                        id: 'd6-6', type: 'stay', time: '16:20', title: '東橫INN 長野站東口', 
                        desc: '相較於熱鬧的善光寺口，東口屬於較新開發的區域，環境相對寧靜寬敞。', 
                        nav: 'Toyoko Inn Nagano-eki Higashi-guchi', highlight: '機械停車塔', travelInfo: '步行' 
                    },
                    { 
                        id: 'd6-7', type: 'food', time: '18:00', title: '晚餐：長野站前', 
                        desc: '兩大推薦：1. 「醬汁豬排丼」(明治亭)。2. 「味噌家」(Misoya) 拉麵。', 
                        nav: 'Nagano Station', highlight: '推薦：明治亭(醬汁豬排)、味噌家(拉麵)' 
                    }
                ]
            },
            {
                id: 'day7', dayLabel: 'Day 7', date: '2/14 (六)', title: '安曇野與諏訪', location: '長野 -> 甲府',
                coords: { lat: 36.0485, lon: 138.1130 },
                events: [
                    { id: 'd7-0', type: 'stay', time: '09:00', title: '出發：東橫INN 長野', desc: '辦理退房。', nav: 'Toyoko Inn Nagano-eki Higashi-guchi', highlight: '', travelInfo: '60km | 50分' },
                    { 
                        id: 'd7-1', type: 'sight', time: '10:15', title: '穂高神社', 
                        desc: '位於安曇野市，被北阿爾卑斯群山環抱的神社，供奉的是海神（穂高見命），守護著交通安全與產業繁榮。', 
                        nav: 'Hotaka Shrine', highlight: '順遊大王山葵農場', travelInfo: '短程 | 10分' 
                    },
                    { 
                        id: 'd7-2', type: 'food', time: '11:30', title: '午餐：信州蕎麥麵', 
                        desc: '長野縣（信州）是蕎麥麵的發源地之一，因地形高、溫差大且水質純淨，種出的蕎麥品質極佳。', 
                        nav: 'Sobadokoro Kamijo', highlight: '推薦：そば処上條', travelInfo: '50km | 1小時' 
                    },
                    { 
                        id: 'd7-3', type: 'sight', time: '14:00', title: '立石公園 (諏訪湖)', 
                        desc: '位於諏訪湖東北側的高地上，是俯瞰整個諏訪湖全景的最佳地點。這裡因為景色酷似動畫電影《你的名字》中「糸守湖」的黃昏場景而爆紅。', 
                        nav: 'Tateishi Park', highlight: '立石公園俯瞰全景', travelInfo: '60km | 1小時' 
                    },
                    { 
                        id: 'd7-4', type: 'stay', time: '17:15', title: 'Dormy Inn 甲府', 
                        desc: '位於甲府市中心，距離甲府車站步行約 15 分鐘。這間 Dormy Inn 最大的亮點是頂樓的天然溫泉「勝運之湯」。', 
                        nav: 'Dormy Inn Kofu Marunouchi', highlight: '', travelInfo: '步行' 
                    },
                    { 
                        id: 'd7-5', type: 'food', time: '18:30', title: '晚餐：甲府餺飥麵', 
                        desc: '山梨縣最具代表性的鄉土料理，相傳是戰國武將武田信玄的野戰食品。特徵是使用寬扁的麵條，加入大量的南瓜、蔬菜與豬肉。', 
                        nav: 'Kosaku Kofu Station', highlight: '推薦：小作 (南瓜餺飥)' 
                    }
                ]
            },
            {
                id: 'day8', dayLabel: 'Day 8', date: '2/15 (日)', title: '富士山與箱根', location: '甲府 -> 箱根',
                coords: { lat: 35.4925, lon: 138.7562 },
                events: [
                    { id: 'd8-0', type: 'stay', time: '09:00', title: '出發：Dormy Inn 甲府', desc: '辦理退房。', nav: 'Dormy Inn Kofu Marunouchi', highlight: '', travelInfo: '40km | 50分' },
                    { 
                        id: 'd8-1', type: 'sight', time: '10:00', title: '河口湖 大石公園', 
                        desc: '位於河口湖北岸，是拍攝「逆富士」（富士山倒映在湖面）的絕佳地點之一。', 
                        nav: 'Oishi Park', highlight: '最佳拍照點', travelInfo: '10km | 20分' 
                    },
                    { 
                        id: 'd8-2', type: 'food', time: '11:30', title: '午餐：吉田烏龍麵', 
                        desc: '富士吉田市的在地庶民美食，以「全日本最硬」的麵條著稱。', 
                        nav: 'Kuranosuke', highlight: '推薦：蔵ノ介', travelInfo: '50km | 1小時15分' 
                    },
                    { 
                        id: 'd8-3', type: 'sight', time: '14:00', title: '箱根神社 & 平和鳥居', 
                        desc: '座落在蘆之湖畔，擁有超過 1200 年歷史，是關東地區總鎮守。最著名的地標是矗立在湖水中的紅色「平和的鳥居」。', 
                        nav: 'Hakone Shrine', highlight: '經御殿場、仙石原', travelInfo: '20km | 40分 (下坡)' 
                    },
                    { id: 'd8-4', type: 'stay', time: '17:00', title: '小田原 住宿', desc: '下山前往小田原。', nav: 'Odawara Station', highlight: '', travelInfo: '步行' },
                    { 
                        id: 'd8-5', type: 'food', time: '18:00', title: '晚餐：小田原關東煮', 
                        desc: '小田原是著名的魚板產地，利用當地豐富的漁獲製作的關東煮自然不同凡響。', 
                        nav: 'Odawara Oden Honten', highlight: '需預約' 
                    }
                ]
            },
            {
                id: 'day9', dayLabel: 'Day 9', date: '2/16 (一)', title: '江之島與橫濱夜景', location: '小田原 -> 橫濱',
                coords: { lat: 35.3192, lon: 139.5467 },
                events: [
                    { id: 'd9-0', type: 'stay', time: '09:30', title: '出發：小田原', desc: '辦理退房，前往小田原城。', nav: 'Odawara Station', highlight: '', travelInfo: '短程' },
                    { 
                        id: 'd9-1', type: 'sight', time: '10:00', title: '小田原城', 
                        desc: '參觀天守閣，看看日本戰國時代的歷史名城。這座城堡曾經是北條氏的居城，以堅固的防禦工事聞名。', 
                        nav: 'Odawara Castle', highlight: '天守閣', travelInfo: '30km | 50分 (海岸)' 
                    },
                    { 
                        id: 'd9-2', type: 'food', time: '12:30', title: '午餐：Coral Reef', 
                        desc: '在國道134號沿線的知名海景餐廳享用午餐。', 
                        nav: 'Coral Reef Moana Makai', highlight: '海景餐廳', travelInfo: '5km | 15分' 
                    },
                    { 
                        id: 'd9-3', type: 'sight', time: '14:00', title: '鎌倉高校前 (灌籃高手)', 
                        desc: '開車經過或暫停拍照。這裡是因為動畫《灌籃高手》片頭曲而爆紅的平交道。', 
                        nav: 'Kamakurakokomae Station', highlight: '灌籃高手平交道', travelInfo: '3km | 10分' 
                    },
                    { 
                        id: 'd9-4', type: 'sight', time: '14:30', title: '江之島深度遊', 
                        desc: '將車停在橋邊或島上。重點行程：1. 參拜江島神社。 2. 搭乘電扶梯(Escar)登上「江之島 Sea Candle」展望燈塔。', 
                        nav: 'Enoshima', highlight: '神社/燈塔/水族館', travelInfo: '30km | 1小時' 
                    },
                    { 
                        id: 'd9-5', type: 'transport', time: '17:00', title: '前往橫濱', 
                        desc: '避開最晚的下班車潮，前往橫濱。', 
                        nav: 'Toyoko Inn Yokohama Stadium Mae No.1', highlight: '前往飯店', travelInfo: '市區 | 10分' 
                    },
                    { 
                        id: 'd9-6', type: 'stay', time: '18:00', title: '東橫INN 橫濱體育場前', 
                        desc: '抵達飯店，辦理入住並停好車。飯店位置極佳，對面就是球場，步行可達中華街與關內車站。', 
                        nav: 'Toyoko Inn Yokohama Stadium Mae No.1', highlight: 'Check-in', travelInfo: '計程車/步行' 
                    },
                    { 
                        id: 'd9-7', type: 'sight', time: '18:40', title: 'YOKOHAMA AIR CABIN', 
                        desc: '搭乘計程車或步行至櫻木町站，搭乘日本首座都市型循環纜車。', 
                        nav: 'YOKOHAMA AIR CABIN', highlight: '橫濱夜景', travelInfo: '步行/短程' 
                    },
                    { 
                        id: 'd9-8', type: 'food', time: '19:10', title: '晚餐：橫濱中華街', 
                        desc: '纜車下車後，直接搭車或散步回中華街享用晚餐。', 
                        nav: 'Yokohama Chinatown', highlight: '中華料理' 
                    }
                ]
            },
            {
                id: 'day10', dayLabel: 'Day 10', date: '2/17 (二)', title: '歸途', location: '橫濱 -> 成田',
                coords: { lat: 35.7719, lon: 140.3929 },
                events: [
                    { id: 'd10-0', type: 'stay', time: '09:00', title: '出發：東橫INN 橫濱', desc: '辦理退房，前往機場。', nav: 'Toyoko Inn Yokohama Stadium Mae No.1', highlight: '檢查護照/行李', travelInfo: '90km | 1.5小時' },
                    { id: 'd10-1', type: 'transport', time: '09:00', title: '前往成田機場', desc: '預留充裕時間還車。', nav: 'Narita International Airport', highlight: '還車期限：13:00前', travelInfo: '機場內' },
                    { id: 'd10-2', type: 'transport', time: '13:00', title: '還車 & 登機', desc: 'Toyota Rent a Car 成田機場店還車。', nav: 'Toyota Rent a Car Narita Airport', highlight: '星宇航空 JX801' }
                ]
            }
        ];

        // --- Utils & Services ---
        const compressImage = (file, maxWidth = 800, quality = 0.7) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(dataUrl);
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        };

        const ensureAuth = async () => {
            if (!window.auth) throw new Error("Firebase auth not initialized");
            if (window.auth.currentUser) return window.auth.currentUser.uid;
            const cred = await window.firebaseModules.signInAnonymously(window.auth);
            return cred.user.uid;
        };

        const subscribeToUserData = (callback) => {
            if (!window.auth || !window.auth.currentUser) return () => {};
            const { collection, onSnapshot } = window.firebaseModules;
            const userId = window.auth.currentUser.uid;
            const eventsRef = collection(window.db, `users/${userId}/events`);
            return onSnapshot(eventsRef, (snapshot) => {
                const data = {};
                snapshot.forEach((doc) => {
                    data[doc.id] = doc.data();
                });
                callback(data);
            });
        };

        const saveEventData = async (eventId, data) => {
            const { doc, setDoc } = window.firebaseModules;
            const userId = await ensureAuth();
            const docRef = doc(window.db, `users/${userId}/events`, eventId);
            await setDoc(docRef, data, { merge: true });
        };

        const subscribeToBudget = (callback) => {
            if (!window.auth || !window.auth.currentUser) return () => {};
            const { collection, onSnapshot } = window.firebaseModules;
            const userId = window.auth.currentUser.uid;
            const budgetRef = collection(window.db, `users/${userId}/budget`);
            return onSnapshot(budgetRef, (snapshot) => {
                const items = [];
                snapshot.forEach((doc) => {
                    items.push({ id: Number(doc.id), ...doc.data() });
                });
                callback(items);
            });
        };

        const addBudgetItem = async (item) => {
            const { doc, setDoc } = window.firebaseModules;
            const userId = await ensureAuth();
            const docRef = doc(window.db, `users/${userId}/budget`, item.id.toString());
            await setDoc(docRef, { desc: item.desc, cost: item.cost });
        };

        const deleteBudgetItem = async (itemId) => {
            const { doc, deleteDoc } = window.firebaseModules;
            const userId = await ensureAuth();
            const docRef = doc(window.db, `users/${userId}/budget`, itemId.toString());
            await deleteDoc(docRef);
        };

        // --- Components ---

        const WeatherWidget = ({ coords }) => {
            const [weather, setWeather] = useState(null);

            useEffect(() => {
                if(coords) {
                    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current_weather=true&timezone=Asia%2FTokyo`)
                        .then(res => res.json())
                        .then(data => setWeather(data.current_weather))
                        .catch(e => console.error("Weather fetch failed", e));
                }
            }, [coords]);

            if (!weather) return <div className="text-xs text-gray-500 flex items-center gap-1"><div className="spinner"></div> 載入天氣...</div>;

            const weatherCodes = {
                0: { label: '晴朗', icon: 'fa-sun', color: 'text-orange-400' },
                1: { label: '多雲', icon: 'fa-cloud-sun', color: 'text-yellow-200' },
                2: { label: '陰天', icon: 'fa-cloud', color: 'text-gray-400' },
                3: { label: '陰天', icon: 'fa-cloud', color: 'text-gray-400' },
                45: { label: '霧', icon: 'fa-smog', color: 'text-gray-300' },
                48: { label: '霧淞', icon: 'fa-snowflake', color: 'text-white' },
                51: { label: '細雨', icon: 'fa-cloud-rain', color: 'text-blue-300' },
                61: { label: '下雨', icon: 'fa-umbrella', color: 'text-blue-400' },
                71: { label: '下雪', icon: 'fa-snowflake', color: 'text-white' },
                80: { label: '陣雨', icon: 'fa-cloud-showers-heavy', color: 'text-blue-500' },
                95: { label: '雷雨', icon: 'fa-bolt', color: 'text-yellow-400' },
            };
            const wCode = weatherCodes[weather.weathercode] || weatherCodes[0];
            
            return (
                <div className="flex items-center gap-2 bg-black/40 px-3 py-1 rounded-full border border-white/10 backdrop-blur-md shadow-lg">
                    <i className={`fas ${wCode.icon} ${wCode.color} text-lg`}></i>
                    <div className="flex flex-col leading-none">
                        <span className="text-lg font-bold text-white">{weather.temperature}<span className="text-xs font-normal">°C</span></span>
                        <span className="text-[10px] text-gray-300">{wCode.label}</span>
                    </div>
                </div>
            );
        };

        const InfoTool = () => (
             <div className="space-y-4 animation-fade-in">
                <div className="bg-jp-dark p-4 rounded-xl shadow-lg border-l-4 border-blue-500">
                    <h3 className="text-white font-bold mb-2 flex items-center"><i className="fas fa-plane mr-2 text-blue-400"></i>航班資訊</h3>
                    <div className="space-y-3 text-sm text-gray-300">
                        <div className="flex justify-between items-center bg-black/20 p-2 rounded">
                            <div><span className="block text-white font-bold">GK14</span> <span className="text-xs">2/8 去程</span></div>
                            <div className="text-right"><span className="block text-white">12:50 TPE</span><span className="block text-white">16:55 NRT</span></div>
                        </div>
                        <div className="flex justify-between items-center bg-black/20 p-2 rounded">
                            <div><span className="block text-white font-bold">JX801</span> <span className="text-xs">2/17 回程</span></div>
                            <div className="text-right"><span className="block text-white">13:40 NRT</span><span className="block text-white">16:45 TPE</span></div>
                        </div>
                    </div>
                </div>
                <div className="bg-jp-dark p-4 rounded-xl shadow-lg border-l-4 border-purple-500">
                    <h3 className="text-white font-bold mb-2 flex items-center"><i className="fas fa-hotel mr-2 text-purple-400"></i>住宿清單</h3>
                    <div className="text-sm text-gray-300 space-y-2 max-h-60 overflow-y-auto">
                        <div className="flex justify-between border-b border-gray-700 pb-1"><span>2/8</span> <span className="text-white">東橫INN 成田機場</span></div>
                        <div className="flex justify-between border-b border-gray-700 pb-1"><span>2/9</span> <span className="text-white">Dormy Inn 水戶</span></div>
                        <div className="flex justify-between border-b border-gray-700 pb-1"><span>2/10</span> <span className="text-white">東橫INN 宇都宮</span></div>
                        <div className="flex justify-between border-b border-gray-700 pb-1"><span>2/11</span> <span className="text-white">坂戶城 (六日町)</span></div>
                        <div className="flex justify-between border-b border-gray-700 pb-1"><span>2/12</span> <span className="text-white">東橫INN 新潟</span></div>
                        <div className="flex justify-between border-b border-gray-700 pb-1"><span>2/13</span> <span className="text-white">東橫INN 長野</span></div>
                        <div className="flex justify-between border-b border-gray-700 pb-1"><span>2/14</span> <span className="text-white">Dormy Inn 甲府</span></div>
                        <div className="flex justify-between border-b border-gray-700 pb-1"><span>2/15</span> <span className="text-white">小田原 住宿</span></div>
                        <div className="flex justify-between border-b border-gray-700 pb-1"><span>2/16</span> <span className="text-white">東橫INN 橫濱</span></div>
                    </div>
                </div>
                <div className="bg-jp-dark p-4 rounded-xl shadow-lg border-l-4 border-red-500">
                    <h3 className="text-white font-bold mb-2 flex items-center"><i className="fas fa-phone mr-2 text-red-400"></i>緊急聯絡</h3>
                    <div className="grid grid-cols-2 gap-3 text-sm">
                        <a href="tel:110" className="bg-red-900/40 py-2 rounded text-center block hover:bg-red-900/60 transition-colors">警察 110</a>
                        <a href="tel:119" className="bg-red-900/40 py-2 rounded text-center block hover:bg-red-900/60 transition-colors">救護 119</a>
                        <div className="col-span-2 bg-gray-700/40 p-2 rounded text-center text-xs">
                            外交部旅外急難救助：+81-80-1009-7179
                        </div>
                    </div>
                </div>
            </div>
        );

        const BudgetTool = () => {
            const [items, setItems] = useState([]);
            const [newItem, setNewItem] = useState({ desc: '', cost: '' });
            const [total, setTotal] = useState(0);

            useEffect(() => {
                const unsubscribe = subscribeToBudget((updatedItems) => {
                    setItems(updatedItems.sort((a, b) => b.id - a.id));
                });
                return () => { if(typeof unsubscribe === 'function') unsubscribe(); }
            }, []);

            useEffect(() => {
                const sum = items.reduce((acc, item) => acc + Number(item.cost), 0);
                setTotal(sum);
            }, [items]);

            const handleAddItem = async () => {
                if (!newItem.desc || !newItem.cost) return;
                const item = {
                    id: Date.now(),
                    desc: newItem.desc,
                    cost: newItem.cost
                };
                await addBudgetItem(item);
                setNewItem({ desc: '', cost: '' });
            };

            return (
                <div className="bg-jp-dark p-4 rounded-xl shadow-lg card-shadow animation-fade-in border border-white/5">
                    <h3 className="text-jp-gold font-bold mb-4 flex items-center justify-between">
                        <span><i className="fas fa-wallet mr-2"></i>旅費記帳 (雲端)</span>
                        <span className="text-2xl font-mono">¥{total.toLocaleString()}</span>
                    </h3>
                    <div className="flex gap-2 mb-4">
                        <input 
                            type="text" 
                            placeholder="項目 (如: 拉麵)" 
                            className="flex-[2] p-3 text-sm bg-black/40 border-gray-700 rounded-lg focus:border-jp-gold transition-colors text-white"
                            value={newItem.desc}
                            onChange={e => setNewItem({...newItem, desc: e.target.value})}
                        />
                        <input 
                            type="number" 
                            placeholder="¥" 
                            className="flex-1 p-3 text-sm bg-black/40 border-gray-700 rounded-lg focus:border-jp-gold transition-colors text-white"
                            value={newItem.cost}
                            onChange={e => setNewItem({...newItem, cost: e.target.value})}
                        />
                        <button onClick={handleAddItem} className="bg-jp-gold text-black px-4 rounded-lg font-bold hover:bg-yellow-500 shadow-lg shadow-yellow-600/20 active:scale-95 transition-all">
                            <i className="fas fa-plus"></i>
                        </button>
                    </div>
                    <div className="max-h-60 overflow-y-auto space-y-2 pr-1">
                        {items.map(item => (
                            <div key={item.id} className="flex justify-between items-center p-3 bg-white/5 rounded-lg border border-white/5 text-sm hover:bg-white/10 transition-colors">
                                <span className="text-white">{item.desc}</span>
                                <div className="flex items-center gap-3">
                                    <span className="font-mono text-gray-300">¥{Number(item.cost).toLocaleString()}</span>
                                    <button onClick={() => deleteBudgetItem(item.id)} className="text-red-500 w-6 h-6 flex items-center justify-center bg-red-500/10 rounded-full hover:bg-red-500/30">
                                        <i className="fas fa-times text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        ))}
                        {items.length === 0 && <div className="text-center text-gray-600 py-4 text-xs italic">尚未新增消費紀錄</div>}
                    </div>
                </div>
            );
        };

        const CardModal = ({ event, userData, onClose }) => {
            const fileInputRef = useRef(null);
            const [isUploading, setIsUploading] = useState(false);
            
            const handlePhotoUpload = async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                setIsUploading(true);
                try {
                    const compressedBase64 = await compressImage(file);
                    const currentPhotos = userData?.photos || [];
                    const newPhotos = [...currentPhotos, compressedBase64];
                    await saveEventData(event.id, { ...userData, photos: newPhotos });
                } catch (error) {
                    console.error("Upload failed", error);
                    alert("照片上傳失敗");
                } finally {
                    setIsUploading(false);
                }
            };

            const handleNoteChange = async (val) => {
                await saveEventData(event.id, { ...userData, notes: val });
            };

            const handleDeletePhoto = async (idxToDelete) => {
                if(!userData?.photos) return;
                const newPhotos = userData.photos.filter((_, i) => i !== idxToDelete);
                await saveEventData(event.id, { ...userData, photos: newPhotos });
            }

            const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(event.nav)}`;
            const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(event.nav)}`;
            const headerColor = {
                transport: 'bg-jp-indigo', sight: 'bg-jp-red', food: 'bg-jp-gold', stay: 'bg-purple-600'
            }[event.type] || 'bg-gray-600';

            return (
                <div className="fixed inset-0 z-[60] flex flex-col bg-[#121212] animation-slide-up">
                    <div className="relative h-64 shrink-0 bg-gray-800">
                        {userData?.photos && userData.photos.length > 0 ? (
                            <img src={userData.photos[0]} className="w-full h-full object-cover opacity-80" alt="Cover" />
                        ) : (
                            <div className={`w-full h-full ${headerColor} opacity-50 flex items-center justify-center`}>
                                <i className={`fas fa-image text-4xl text-white/30`}></i>
                            </div>
                        )}
                        <button onClick={onClose} className="absolute top-4 right-4 z-10 w-10 h-10 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black/70 backdrop-blur">
                            <i className="fas fa-times text-lg"></i>
                        </button>
                        <div className="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-[#121212] to-transparent">
                            <span className="inline-block px-2 py-0.5 rounded bg-white/20 text-white text-xs mb-2 backdrop-blur-sm border border-white/20">
                                {event.time}
                            </span>
                            <h2 className="text-3xl font-bold text-white leading-tight shadow-black drop-shadow-md">{event.title}</h2>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 pb-24">
                        <div className="flex gap-3 mb-6">
                            <a href={navUrl} target="_blank" rel="noopener noreferrer" className="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-blue-900/50 active:scale-95 transition-transform no-underline">
                                <i className="fas fa-location-arrow"></i> 導航
                            </a>
                             <a href={searchUrl} target="_blank" rel="noopener noreferrer" className="flex-1 bg-gray-700 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform no-underline">
                                <i className="fab fa-google"></i> 搜尋
                            </a>
                        </div>
                        <div className="mb-6">
                            <h3 className="text-jp-gold text-sm font-bold uppercase tracking-wider mb-2">關於此地</h3>
                            <p className="text-gray-300 leading-relaxed text-lg whitespace-pre-line">{event.desc}</p>
                        </div>
                        {event.highlight && (
                            <div className="mb-6 p-4 bg-jp-gold/10 border-l-4 border-jp-gold rounded-r-lg">
                                <h3 className="text-jp-gold text-sm font-bold mb-1"><i className="fas fa-lightbulb mr-2"></i>攻略筆記</h3>
                                <p className="text-gray-200">{event.highlight}</p>
                                {event.subInfo && <p className="text-gray-400 text-sm mt-1">{event.subInfo}</p>}
                            </div>
                        )}
                        <div className="mb-8">
                            <h3 className="text-jp-gold text-sm font-bold uppercase tracking-wider mb-2">我的備註</h3>
                            <textarea 
                                className="w-full bg-gray-800 text-white p-4 rounded-xl border border-gray-700 focus:border-jp-gold min-h-[120px] text-base"
                                placeholder="寫下旅行心情或備忘錄 (自動儲存)..."
                                defaultValue={userData?.notes || ''}
                                onBlur={(e) => handleNoteChange(e.target.value)}
                            />
                        </div>
                        <div>
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-jp-gold text-sm font-bold uppercase tracking-wider">相簿 ({userData?.photos?.length || 0})</h3>
                                <button 
                                    onClick={() => fileInputRef.current?.click()}
                                    disabled={isUploading}
                                    className="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm text-white transition-colors border border-gray-700 flex items-center"
                                >
                                     {isUploading ? <span className="spinner mr-2"></span> : <i className="fas fa-camera mr-2"></i>}
                                     {isUploading ? '處理中...' : '新增照片'}
                                </button>
                                <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handlePhotoUpload} />
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                {userData?.photos?.map((photo, idx) => (
                                    <div key={idx} className="aspect-square rounded-xl bg-gray-800 overflow-hidden relative group shadow-lg">
                                        <img src={photo} className="w-full h-full object-cover" alt={`Upload ${idx}`} />
                                        <button 
                                            className="absolute top-2 right-2 bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center shadow-lg"
                                            onClick={() => handleDeletePhoto(idx)}
                                        >
                                            <i className="fas fa-trash text-sm"></i>
                                        </button>
                                    </div>
                                ))}
                                {(!userData?.photos || userData.photos.length === 0) && (
                                    <div className="col-span-2 py-8 text-center text-gray-600 border-2 border-dashed border-gray-800 rounded-xl">
                                        尚無照片，點擊新增按鈕上傳
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Card = ({ event, userData, onOpenModal }) => {
            const hasCover = userData?.photos && userData.photos.length > 0;
            const coverImage = hasCover ? userData?.photos?.[0] : null;
            const styles = {
                transport: { icon: 'fa-car', color: 'text-jp-indigo', border: 'border-jp-indigo' },
                sight: { icon: 'fa-torii-gate', color: 'text-jp-red', border: 'border-jp-red' },
                food: { icon: 'fa-utensils', color: 'text-jp-gold', border: 'border-jp-gold' },
                stay: { icon: 'fa-bed', color: 'text-purple-400', border: 'border-purple-500' }
            }[event.type] || { icon: 'fa-circle', color: 'text-gray-400', border: 'border-gray-500' };
            const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(event.nav)}`;

            return (
                <div className="relative pl-4 pb-8 group">
                    <div className="absolute left-[19px] top-8 bottom-0 w-0.5 bg-gray-800 group-last:hidden"></div>
                    <div 
                        onClick={onOpenModal}
                        className={`relative rounded-xl overflow-hidden shadow-lg bg-jp-dark active:scale-[0.98] transition-all duration-200 cursor-pointer border-l-4 ${styles.border}`}
                    >
                        {hasCover && coverImage && (
                            <div className="absolute inset-0 z-0">
                                <img src={coverImage} className="w-full h-full object-cover opacity-60" alt="Cover" />
                                <div className="absolute inset-0 card-bg-gradient"></div>
                            </div>
                        )}
                        <div className="relative z-10 p-4">
                            <div className="flex items-start gap-3">
                                <div className={`mt-0.5 w-8 h-8 rounded-full flex items-center justify-center bg-black/40 backdrop-blur-sm border border-white/10 shrink-0`}>
                                    <i className={`fas ${styles.icon} ${hasCover ? 'text-white' : styles.color}`}></i>
                                </div>
                                <div className="flex-1 min-w-0">
                                    <div className="flex justify-between items-start">
                                        <span className={`text-xs font-mono tracking-wide ${hasCover ? 'text-gray-200' : 'text-gray-400'}`}>{event.time}</span>
                                        <a 
                                            href={navUrl} 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            onClick={(e) => e.stopPropagation()} 
                                            className="px-2 py-1 rounded bg-blue-600/30 hover:bg-blue-600/50 text-blue-300 text-xs flex items-center gap-1 border border-blue-500/30"
                                        >
                                            <i className="fas fa-location-arrow text-[10px]"></i> 導航
                                        </a>
                                    </div>
                                    <h3 className={`text-lg font-bold mb-1 truncate ${hasCover ? 'text-white shadow-black drop-shadow-md' : 'text-jp-light'}`}>{event.title}</h3>
                                    <p className={`text-sm truncate ${hasCover ? 'text-gray-200' : 'text-gray-400'}`}>{event.desc}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {event.travelInfo && (
                         <div className="absolute left-[38px] bottom-[2px] transform translate-y-1/2 z-0 pl-4 w-full">
                            <div className="flex items-center gap-2">
                                <div className="h-[1px] w-4 bg-gray-700 shrink-0"></div>
                                <div className="flex items-center bg-gray-800 text-gray-300 px-2 py-1 rounded-full border border-gray-700 shadow-sm max-w-[85%]">
                                    <i className="fas fa-car text-[10px] mr-2 text-gray-400 shrink-0"></i>
                                    <span className="text-[10px] whitespace-nowrap font-mono overflow-hidden text-ellipsis">{event.travelInfo}</span>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [selectedDayId, setSelectedDayId] = useState('day1');
            const [userDataStore, setUserDataStore] = useState({});
            const [modalData, setModalData] = useState(null);
            const [activeTab, setActiveTab] = useState('itinerary');
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                const initAuthAndSync = async () => {
                     try {
                        if (!window.db) {
                            // Wait a bit for Firebase to init
                            await new Promise(r => setTimeout(r, 1000));
                            if (!window.db) throw new Error("Firebase not initialized in window");
                        }

                        await ensureAuth();
                        const unsubscribe = subscribeToUserData((data) => {
                            setUserDataStore(data);
                            setIsLoading(false);
                        });
                        return unsubscribe;
                     } catch (e) {
                         console.error("Auth/Sync failed", e);
                         setIsLoading(false);
                         if (e.code === 'auth/configuration-not-found' || e.code === 'auth/operation-not-allowed') {
                             setError({
                                title: "尚未啟用匿名登入",
                                message: "Firebase Authentication 的「匿名登入」功能尚未開啟。",
                                code: 'AUTH_CONFIG'
                             });
                         } else {
                             setError({
                                title: "資料庫連線錯誤",
                                message: e.message || "未知錯誤",
                             });
                         }
                     }
                };
                initAuthAndSync();
            }, []);

            if (error) {
                return (
                    <div className="min-h-screen bg-[#121212] flex flex-col items-center justify-center p-8 text-center text-white font-sans">
                        <div className="w-16 h-16 rounded-full bg-red-900/50 flex items-center justify-center mb-4 text-red-400 text-3xl border border-red-500/30">
                            <i className="fas fa-exclamation-triangle"></i>
                        </div>
                        <h2 className="text-xl font-bold mb-2 text-white">{error.title}</h2>
                        <p className="text-gray-400 mb-6 max-w-md leading-relaxed text-sm whitespace-pre-line">{error.message}</p>
                        <button onClick={() => window.location.reload()} className="mt-8 px-6 py-3 bg-jp-gold text-black font-bold rounded-lg hover:bg-yellow-500 transition-colors">
                            <i className="fas fa-sync-alt mr-2"></i>重試
                        </button>
                    </div>
                );
            }

            const currentDay = INITIAL_ITINERARY.find(d => d.id === selectedDayId);
            if (!currentDay) return null;

            return (
                <div className="min-h-screen bg-[#121212] pb-20 relative font-sans text-jp-light">
                    <div className="sticky top-0 z-40 bg-[#121212]/90 backdrop-blur-md border-b border-white/5 pt-env-top">
                        <div className="px-4 py-3 flex justify-between items-center">
                            <div>
                                <h1 className="text-white font-bold tracking-widest text-lg">2026 關東自駕</h1>
                                <p className="text-xs text-gray-400 flex items-center gap-1">
                                    <i className="fas fa-map-marker-alt text-jp-red"></i> {currentDay.location.split(' ')[0]}
                                    {isLoading && <span className="ml-2 spinner w-3 h-3"></span>}
                                </p>
                            </div>
                            {activeTab === 'itinerary' && (
                                <WeatherWidget coords={currentDay.coords} />
                            )}
                        </div>
                        {activeTab === 'itinerary' && (
                            <div className="flex overflow-x-auto hide-scrollbar gap-2 px-4 pb-3">
                                {INITIAL_ITINERARY.map(day => (
                                    <button
                                        key={day.id}
                                        onClick={() => setSelectedDayId(day.id)}
                                        className={`flex-shrink-0 px-4 py-2 rounded-lg text-sm transition-all border ${
                                            selectedDayId === day.id 
                                            ? 'bg-jp-red text-white border-jp-red shadow-lg shadow-red-900/40' 
                                            : 'bg-jp-dark text-gray-400 border-gray-700'
                                        }`}
                                    >
                                        <span className="block text-[10px] opacity-70 mb-0.5">{day.date}</span>
                                        <span className="font-bold">{day.dayLabel}</span>
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>
                    <div className="p-4 pt-6">
                         {activeTab === 'itinerary' ? (
                            <div className="animation-fade-in pb-12">
                                {currentDay.events.map(event => (
                                    <Card 
                                        key={event.id} 
                                        event={event} 
                                        userData={userDataStore[event.id]}
                                        onOpenModal={() => setModalData(event)}
                                    />
                                ))}
                            </div>
                         ) : (
                             <div className="space-y-6 pb-12">
                                <InfoTool />
                                <BudgetTool />
                                <div className="text-center text-xs text-gray-600 mt-8">
                                    <p>資料同步至 Firebase Firestore</p>
                                    <p>所有資料皆綁定此裝置 (匿名登入)</p>
                                </div>
                             </div>
                         )}
                    </div>
                    {modalData && (
                        <CardModal 
                            event={modalData}
                            userData={userDataStore[modalData.id]}
                            onClose={() => setModalData(null)}
                        />
                    )}
                    <div className="fixed bottom-0 left-0 right-0 glass-panel border-t border-white/10 pb-env-bottom z-50">
                        <div className="flex justify-around items-center h-16">
                            <button onClick={() => setActiveTab('itinerary')} className={`${activeTab === 'itinerary' ? 'text-jp-gold' : 'text-gray-500'} flex flex-col items-center w-full active:scale-95 transition-transform`}>
                                <i className="fas fa-route text-xl mb-1"></i><span className="text-[10px]">行程</span>
                            </button>
                            <button onClick={() => setActiveTab('tools')} className={`${activeTab === 'tools' ? 'text-jp-gold' : 'text-gray-500'} flex flex-col items-center w-full active:scale-95 transition-transform`}>
                                <i className="fas fa-toolbox text-xl mb-1"></i><span className="text-[10px]">工具</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
    
